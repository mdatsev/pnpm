"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _lodash = _interopRequireDefault(require("lodash"));

var _utils = require("../../../lib/utils");

var _middleware = require("../../middleware");

var _constants = require("../../../lib/constants");

var _user = require("../../../utils/user");

var _logger = require("../../../lib/logger");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const getOrder = (order = 'asc') => {
  return order === 'asc';
};

function addPackageWebApi(route, storage, auth, config) {
  const can = (0, _middleware.allow)(auth);

  const checkAllow = (name, remoteUser) => new Promise((resolve, reject) => {
    try {
      auth.allow_access({
        packageName: name
      }, remoteUser, (err, allowed) => {
        if (err) {
          resolve(false);
        } else {
          resolve(allowed);
        }
      });
    } catch (err) {
      reject(err);
    }
  }); // Get list of all visible package


  route.get('/packages', function (req, res, next) {
    storage.getLocalDatabase(async function (err, packages) {
      if (err) {
        throw err;
      }

      async function processPermissionsPackages(packages = []) {
        const permissions = [];
        const packgesCopy = packages.slice();

        for (const pkg of packgesCopy) {
          const pkgCopy = _objectSpread({}, pkg);

          pkgCopy.author = (0, _utils.formatAuthor)(pkg.author);

          try {
            if (await checkAllow(pkg.name, req.remote_user)) {
              if (config.web) {
                pkgCopy.author.avatar = (0, _user.generateGravatarUrl)(pkgCopy.author.email, config.web.gravatar);
              }

              permissions.push(pkgCopy);
            }
          } catch (err) {
            _logger.logger.logger.error({
              name: pkg.name,
              error: err
            }, 'permission process for @{name} has failed: @{error}');

            throw err;
          }
        }

        return permissions;
      }

      const {
        web
      } = config; // @ts-ignore

      const order = config.web ? getOrder(web.sort_packages) : true;
      next((0, _utils.sortByName)((await processPermissionsPackages(packages)), order));
    });
  }); // Get package readme

  route.get('/package/readme/(@:scope/)?:package/:version?', can('access'), function (req, res, next) {
    const packageName = req.params.scope ? (0, _utils.addScope)(req.params.scope, req.params.package) : req.params.package;
    storage.getPackage({
      name: packageName,
      uplinksLook: true,
      req,
      callback: function (err, info) {
        if (err) {
          return next(err);
        }

        res.set(_constants.HEADER_TYPE.CONTENT_TYPE, _constants.HEADERS.TEXT_PLAIN);
        next((0, _utils.parseReadme)(info.name, info.readme));
      }
    });
  });
  route.get('/sidebar/(@:scope/)?:package', function (req, res, next) {
    const packageName = req.params.scope ? (0, _utils.addScope)(req.params.scope, req.params.package) : req.params.package;
    storage.getPackage({
      name: packageName,
      uplinksLook: true,
      keepUpLinkData: true,
      req,
      callback: function (err, info) {
        if (_lodash.default.isNil(err)) {
          const {
            v
          } = req.query;

          let sideBarInfo = _lodash.default.clone(info);

          sideBarInfo.versions = (0, _utils.convertDistRemoteToLocalTarballUrls)(info, req, config.url_prefix).versions;

          if ((0, _utils.isVersionValid)(info, v)) {
            sideBarInfo.latest = sideBarInfo.versions[v];
            sideBarInfo.latest.author = (0, _utils.formatAuthor)(sideBarInfo.latest.author);
          } else {
            sideBarInfo.latest = sideBarInfo.versions[info[_constants.DIST_TAGS].latest];
            sideBarInfo.latest.author = (0, _utils.formatAuthor)(sideBarInfo.latest.author);
          }

          sideBarInfo = (0, _utils.deleteProperties)(['readme', '_attachments', '_rev', 'name'], sideBarInfo);

          if (config.web) {
            sideBarInfo = (0, _utils.addGravatarSupport)(sideBarInfo, config.web.gravatar);
          } else {
            sideBarInfo = (0, _utils.addGravatarSupport)(sideBarInfo);
          }

          next(sideBarInfo);
        } else {
          res.status(_constants.HTTP_STATUS.NOT_FOUND);
          res.end();
        }
      }
    });
  });
}

var _default = addPackageWebApi;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9hcGkvd2ViL2VuZHBvaW50L3BhY2thZ2UudHMiXSwibmFtZXMiOlsiZ2V0T3JkZXIiLCJvcmRlciIsImFkZFBhY2thZ2VXZWJBcGkiLCJyb3V0ZSIsInN0b3JhZ2UiLCJhdXRoIiwiY29uZmlnIiwiY2FuIiwiY2hlY2tBbGxvdyIsIm5hbWUiLCJyZW1vdGVVc2VyIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJhbGxvd19hY2Nlc3MiLCJwYWNrYWdlTmFtZSIsImVyciIsImFsbG93ZWQiLCJnZXQiLCJyZXEiLCJyZXMiLCJuZXh0IiwiZ2V0TG9jYWxEYXRhYmFzZSIsInBhY2thZ2VzIiwicHJvY2Vzc1Blcm1pc3Npb25zUGFja2FnZXMiLCJwZXJtaXNzaW9ucyIsInBhY2tnZXNDb3B5Iiwic2xpY2UiLCJwa2ciLCJwa2dDb3B5IiwiYXV0aG9yIiwicmVtb3RlX3VzZXIiLCJ3ZWIiLCJhdmF0YXIiLCJlbWFpbCIsImdyYXZhdGFyIiwicHVzaCIsImxvZ2dlciIsImVycm9yIiwic29ydF9wYWNrYWdlcyIsInBhcmFtcyIsInNjb3BlIiwicGFja2FnZSIsImdldFBhY2thZ2UiLCJ1cGxpbmtzTG9vayIsImNhbGxiYWNrIiwiaW5mbyIsInNldCIsIkhFQURFUl9UWVBFIiwiQ09OVEVOVF9UWVBFIiwiSEVBREVSUyIsIlRFWFRfUExBSU4iLCJyZWFkbWUiLCJrZWVwVXBMaW5rRGF0YSIsIl8iLCJpc05pbCIsInYiLCJxdWVyeSIsInNpZGVCYXJJbmZvIiwiY2xvbmUiLCJ2ZXJzaW9ucyIsInVybF9wcmVmaXgiLCJsYXRlc3QiLCJESVNUX1RBR1MiLCJzdGF0dXMiLCJIVFRQX1NUQVRVUyIsIk5PVF9GT1VORCIsImVuZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQVVBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7Ozs7O0FBS0EsTUFBTUEsUUFBUSxHQUFHLENBQUNDLEtBQUssR0FBRyxLQUFULEtBQW1CO0FB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TUFBWixDQUFtQmhDLE1BQW5CLEdBQTRCLHlCQUFhNEIsV0FBVyxDQUFDSSxNQUFaLENBQW1CaEMsTUFBaEMsQ0FBNUI7QUFDRDs7QUFDRDRCLFVBQUFBLFdBQVcsR0FBRyw2QkFBaUIsQ0FBQyxRQUFELEVBQVcsY0FBWCxFQUEyQixNQUEzQixFQUFtQyxNQUFuQyxDQUFqQixFQUE2REEsV0FBN0QsQ0FBZDs7QUFDQSxjQUFJcEQsTUFBTSxDQUFDMEIsR0FBWCxFQUFnQjtBQUNkMEIsWUFBQUEsV0FBVyxHQUFHLCtCQUFtQkEsV0FBbkIsRUFBZ0NwRCxNQUFNLENBQUMwQixHQUFQLENBQVdHLFFBQTNDLENBQWQ7QUFDRCxXQUZELE1BRU87QUFDTHVCLFlBQUFBLFdBQVcsR0FBRywrQkFBbUJBLFdBQW5CLENBQWQ7QUFDRDs7QUFDRHJDLFVBQUFBLElBQUksQ0FBQ3FDLFdBQUQsQ0FBSjtBQUNELFNBbEJILE1Ba0JTO0FBQ0x0QyxVQUFBQSxHQUFHLENBQUM0QyxNQUFKLENBQVdDLHVCQUFZQyxTQUF2QjtBQUNBOUMsVUFBQUEsR0FBRyxDQUFDK0MsR0FBSjtBQUNEO0FBQ0Y7QUE1QmMsS0FBbkI7QUE4QkQsR0FqQ0Q7QUFrQ0Q7O2VBRWNqRSxnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQge1xuICBhZGRTY29wZSxcbiAgYWRkR3JhdmF0YXJTdXBwb3J0LFxuICBkZWxldGVQcm9wZXJ0aWVzLFxuICBzb3J0QnlOYW1lLFxuICBwYXJzZVJlYWRtZSxcbiAgZm9ybWF0QXV0aG9yLFxuICBjb252ZXJ0RGlzdFJlbW90ZVRvTG9jYWxUYXJiYWxsVXJscyxcbiAgaXNWZXJzaW9uVmFsaWRcbn0gZnJvbSAnLi4vLi4vLi4vbGliL3V0aWxzJztcbmltcG9ydCB7IGFsbG93IH0gZnJvbSAnLi4vLi4vbWlkZGxld2FyZSc7XG5pbXBvcnQgeyBESVNUX1RBR1MsIEhFQURFUl9UWVBFLCBIRUFERVJTLCBIVFRQX1NUQVRVUyB9IGZyb20gJy4uLy4uLy4uL2xpYi9jb25zdGFudHMnO1xuaW1wb3J0IHsgZ2VuZXJhdGVHcmF2YXRhclVybCB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL3VzZXInO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vLi4vLi4vbGliL2xvZ2dlcic7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IElBdXRoLCAkUmVzcG9uc2VFeHRlbmQsICRSZXF1ZXN0RXh0ZW5kLCAkTmV4dEZ1bmN0aW9uVmVyLCBJU3RvcmFnZUhhbmRsZXIsICRTaWRlYmFyUGFja2FnZSB9IGZyb20gJy4uLy4uLy4uLy4uL3R5cGVzJztcbmltcG9ydCB7IENvbmZpZywgUGFja2FnZSB9IGZyb20gJ0B2ZXJkYWNjaW8vdHlwZXMnO1xuXG5jb25zdCBnZXRPcmRlciA9IChvcmRlciA9ICdhc2MnKSA9PiB7XG4gIHJldHVybiBvcmRlciA9PT0gJ2FzYyc7XG59O1xuXG5leHBvcnQgdHlwZSBQYWNrY2FnZUF1dGhvciA9IFBhY2thZ2UgJiB7IGF1dGhvcjogYW55IH07XG5cbmZ1bmN0aW9uIGFkZFBhY2thZ2VXZWJBcGkocm91dGU6IFJvdXRlciwgc3RvcmFnZTogSVN0b3JhZ2VIYW5kbGVyLCBhdXRoOiBJQXV0aCwgY29uZmlnOiBDb25maWcpOiB2b2lkIHtcbiAgY29uc3QgY2FuID0gYWxsb3coYXV0aCk7XG5cbiAgY29uc3QgY2hlY2tBbGxvdyA9IChuYW1lLCByZW1vdGVVc2VyKTogUHJvbWlzZTxib29sZWFuPiA9PlxuICAgIG5ldyBQcm9taXNlKFxuICAgICAgKHJlc29sdmUsIHJlamVjdCk6IHZvaWQgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF1dGguYWxsb3dfYWNjZXNzKFxuICAgICAgICAgICAgeyBwYWNrYWdlTmFtZTogbmFtZSB9LFxuICAgICAgICAgICAgcmVtb3RlVXNlcixcbiAgICAgICAgICAgIChlcnIsIGFsbG93ZWQpOiB2b2lkID0+IHtcbiAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoZmFsc2UpO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoYWxsb3dlZCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICApO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICk7XG5cbiAgLy8gR2V0IGxpc3Qgb2YgYWxsIHZpc2libGUgcGFja2FnZVxuICByb3V0ZS5nZXQoJy9wYWNrYWdlcycsIGZ1bmN0aW9uKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKTogdm9pZCB7XG4gICAgc3RvcmFnZS5nZXRMb2NhbERhdGFiYXNlKGFzeW5jIGZ1bmN0aW9uKGVyciwgcGFja2FnZXMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuXG4gICAgICBhc3luYyBmdW5jdGlvbiBwcm9jZXNzUGVybWlzc2lvbnNQYWNrYWdlcyhwYWNrYWdlczogUGFja2NhZ2VBdXRob3JbXSA9IFtdKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbnM6IFBhY2tjYWdlQXV0aG9yW10gPSBbXTtcbiAgICAgICAgY29uc3QgcGFja2dlc0NvcHkgPSBwYWNrYWdlcy5zbGljZSgpO1xuICAgICAgICBmb3IgKGNvbnN0IHBrZyBvZiBwYWNrZ2VzQ29weSkge1xuICAgICAgICAgIGNvbnN0IHBrZ0NvcHkgPSB7IC4uLnBrZyB9O1xuICAgICAgICAgIHBrZ0NvcHkuYXV0aG9yID0gZm9ybWF0QXV0aG9yKHBrZy5hdXRob3IpO1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoYXdhaXQgY2hlY2tBbGxvdyhwa2cubmFtZSwgcmVxLnJlbW90ZV91c2VyKSkge1xuICAgICAgICAgICAgICBpZiAoY29uZmlnLndlYikge1xuICAgICAgICAgICAgICAgIHBrZ0NvcHkuYXV0aG9yLmF2YXRhciA9IGdlbmVyYXRlR3JhdmF0YXJVcmwocGtnQ29weS5hdXRob3IuZW1haWwsIGNvbmZpZy53ZWIuZ3JhdmF0YXIpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHBlcm1pc3Npb25zLnB1c2gocGtnQ29weSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBsb2dnZXIubG9nZ2VyLmVycm9yKHsgbmFtZTogcGtnLm5hbWUsIGVycm9yOiBlcnIgfSwgJ3Blcm1pc3Npb24gcHJvY2VzcyBmb3IgQHtuYW1lfSBoYXMgZmFpbGVkOiBAe2Vycm9yfScpO1xuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBwZXJtaXNzaW9ucztcbiAgICAgIH1cblxuICAgICAgY29uc3QgeyB3ZWIgfSA9IGNvbmZpZztcbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIGNvbnN0IG9yZGVyOiBib29sZWFuID0gY29uZmlnLndlYiA/IGdldE9yZGVyKHdlYi5zb3J0X3BhY2thZ2VzKSA6IHRydWU7XG5cbiAgICAgIG5leHQoc29ydEJ5TmFtZShhd2FpdCBwcm9jZXNzUGVybWlzc2lvbnNQYWNrYWdlcyhwYWNrYWdlcyksIG9yZGVyKSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIC8vIEdldCBwYWNrYWdlIHJlYWRtZVxuICByb3V0ZS5nZXQoJy9wYWNrYWdlL3JlYWRtZS8oQDpzY29wZS8pPzpwYWNrYWdlLzp2ZXJzaW9uPycsIGNhbignYWNjZXNzJyksIGZ1bmN0aW9uKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKTogdm9pZCB7XG4gICAgY29uc3QgcGFja2FnZU5hbWUgPSByZXEucGFyYW1zLnNjb3BlID8gYWRkU2NvcGUocmVxLnBhcmFtcy5zY29wZSwgcmVxLnBhcmFtcy5wYWNrYWdlKSA6IHJlcS5wYXJhbXMucGFja2FnZTtcblxuICAgIHN0b3JhZ2UuZ2V0UGFja2FnZSh7XG4gICAgICBuYW1lOiBwYWNrYWdlTmFtZSxcbiAgICAgIHVwbGlua3NMb29rOiB0cnVlLFxuICAgICAgcmVxLFxuICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uKGVyciwgaW5mbyk6IHZvaWQge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmV0dXJuIG5leHQoZXJyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlcy5zZXQoSEVBREVSX1RZUEUuQ09OVEVOVF9UWVBFLCBIRUFERVJTLlRFWFRfUExBSU4pO1xuICAgICAgICBuZXh0KHBhcnNlUmVhZG1lKGluZm8ubmFtZSwgaW5mby5yZWFkbWUpKTtcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHJvdXRlLmdldCgnL3NpZGViYXIvKEA6c2NvcGUvKT86cGFja2FnZScsIGZ1bmN0aW9uKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKTogdm9pZCB7XG4gICAgY29uc3QgcGFja2FnZU5hbWU6IHN0cmluZyA9IHJlcS5wYXJhbXMuc2NvcGUgPyBhZGRTY29wZShyZXEucGFyYW1zLnNjb3BlLCByZXEucGFyYW1zLnBhY2thZ2UpIDogcmVxLnBhcmFtcy5wYWNrYWdlO1xuXG4gICAgc3RvcmFnZS5nZXRQYWNrYWdlKHtcbiAgICAgIG5hbWU6IHBhY2thZ2VOYW1lLFxuICAgICAgdXBsaW5rc0xvb2s6IHRydWUsXG4gICAgICBrZWVwVXBMaW5rRGF0YTogdHJ1ZSxcbiAgICAgIHJlcSxcbiAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbihlcnI6IEVycm9yLCBpbmZvOiAkU2lkZWJhclBhY2thZ2UpOiB2b2lkIHtcbiAgICAgICAgaWYgKF8uaXNOaWwoZXJyKSkge1xuICAgICAgICAgIGNvbnN0IHt2fSA9IHJlcS5xdWVyeTtcbiAgICAgICAgICBsZXQgc2lkZUJhckluZm86IGFueSA9IF8uY2xvbmUoaW5mbyk7XG4gICAgICAgICAgc2lkZUJhckluZm8udmVyc2lvbnMgPSBjb252ZXJ0RGlzdFJlbW90ZVRvTG9jYWxUYXJiYWxsVXJscyhpbmZvLCByZXEsIGNvbmZpZy51cmxfcHJlZml4KS52ZXJzaW9ucztcbiAgICAgICAgICBpZiAoaXNWZXJzaW9uVmFsaWQoaW5mbywgdikpIHtcbiAgICAgICAgICAgIHNpZGVCYXJJbmZvLmxhdGVzdCA9IHNpZGVCYXJJbmZvLnZlcnNpb25zW3ZdO1xuICAgICAgICAgICAgc2lkZUJhckluZm8ubGF0ZXN0LmF1dGhvciA9IGZvcm1hdEF1dGhvcihzaWRlQmFySW5mby5sYXRlc3QuYXV0aG9yKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHNpZGVCYXJJbmZvLmxhdGVzdCA9IHNpZGVCYXJJbmZvLnZlcnNpb25zW2luZm9bRElTVF9UQUdTXS5sYXRlc3RdO1xuICAgICAgICAgICAgICBzaWRlQmFySW5mby5sYXRlc3QuYXV0aG9yID0gZm9ybWF0QXV0aG9yKHNpZGVCYXJJbmZvLmxhdGVzdC5hdXRob3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2lkZUJhckluZm8gPSBkZWxldGVQcm9wZXJ0aWVzKFsncmVhZG1lJywgJ19hdHRhY2htZW50cycsICdfcmV2JywgJ25hbWUnXSwgc2lkZUJhckluZm8pO1xuICAgICAgICAgICAgaWYgKGNvbmZpZy53ZWIpIHtcbiAgICAgICAgICAgICAgc2lkZUJhckluZm8gPSBhZGRHcmF2YXRhclN1cHBvcnQoc2lkZUJhckluZm8sIGNvbmZpZy53ZWIuZ3JhdmF0YXIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgc2lkZUJhckluZm8gPSBhZGRHcmF2YXRhclN1cHBvcnQoc2lkZUJhckluZm8pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbmV4dChzaWRlQmFySW5mbyk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuTk9UX0ZPVU5EKTtcbiAgICAgICAgICAgIHJlcy5lbmQoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGFkZFBhY2thZ2VXZWJBcGk7XG4iXX0=