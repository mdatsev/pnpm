"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.validatePassword = validatePassword;
exports.createRemoteUser = createRemoteUser;
exports.createAnonymousRemoteUser = createAnonymousRemoteUser;
exports.allow_action = allow_action;
exports.handleSpecialUnpublish = handleSpecialUnpublish;
exports.getDefaultPlugins = getDefaultPlugins;
exports.createSessionToken = createSessionToken;
exports.getSecurity = getSecurity;
exports.getAuthenticatedMessage = getAuthenticatedMessage;
exports.buildUserBuffer = buildUserBuffer;
exports.isAESLegacy = isAESLegacy;
exports.getApiToken = getApiToken;
exports.parseAuthTokenHeader = parseAuthTokenHeader;
exports.parseBasicPayload = parseBasicPayload;
exports.parseAESCredentials = parseAESCredentials;
exports.verifyJWTPayload = verifyJWTPayload;
exports.isAuthHeaderValid = isAuthHeaderValid;
exports.getMiddlewareCredentials = getMiddlewareCredentials;
exports.expireReasons = exports.defaultSecurity = void 0;

var _lodash = _interopRequireDefault(require("lodash"));

var _utils = require("./utils");

var _constants = require("./constants");

var _cryptoUtils = require("./crypto-utils");

var _logger = require("../lib/logger");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function validatePassword(password, minLength = _constants.DEFAULT_MIN_LIMIT_PASSWORD) {
  return typeof password === 'string' && password.length >= minLength;
}
/**
 * Create a RemoteUser object
 * @return {Object} { name: xx, pluginGroups: [], real_groups: [] }
 */


function createRemoteUser(name, pluginGroups) {
  const isGroupValid = Array.isArray(pluginGroups);
  const groups = (isGroupValid ? pluginGroups : []).concat([_constants.ROLES.$ALL, _constants.ROLES.$AUTH, _constants.ROLES.DEPRECATED_ALL, _constants.ROLES.DEPRECATED_AUTH, _constants.ROLES.ALL]);
  return {
    name,
    groups,
    real_groups: pluginGroups
  };
}
/**
 * Builds an anonymous remote user in case none is logged in.
 * @return {Object} { name: xx, groups: [], real_groups: [] }
 */


function createAnonymousRemoteUser() {
  return {
    name: undefined,
    // groups without '$' are going to be deprecated eventually
    groups: [_constants.ROLES.$ALL, _constants.ROLES.$ANONYMOUS, _constants.ROLES.DEPRECATED_ALL, _constants.ROLES.DEPRECATED_ANONYMOUS],
    real_groups: []
  };
}

function allow_action(action) {
  return function (user, pkg, callback) {
    _logger.logger.trace({
      remote: user.name
    }, `[auth/allow_action]: user: @{user.name}`);

    const {
      name,
      groups
    } = user;
    const groupAccess = pkg[action];
    const hasPermission = groupAccess.some(group => name === group || groups.includes(group));

    _logger.logger.trace({
      pkgName: pkg.name,
      hasPermission,
      remote: user.name,
      groupAccess
    }, `[auth/allow_action]: hasPermission? @{hasPermission} for user: @{user}`);

    if (hasPermission) {
      _logger.logger.trace({
        remote: user.name
      }, `auth/allow_action: access granted to: @{user}`);

      return callback(null, true);
    }

    if (name) {
      callback(_utils.ErrorCode.getForbidden(`user ${name} is not allowed to ${action} package ${pkg.name}`));
    } else {
      callback(_utils.ErrorCode.getUnauthorized(`authorization required to ${action} package ${pkg.name}`));
    }
  };
}
/**
 *
 */


function handleSpecialUnpublish() {
  return function (user, pkg, callback) {
    const action = 'unpublish'; // verify whether the unpublish prop has been defined

    const isUnpublishMissing = _lodash.default.isNil(pkg[action]);

    const hasGroups = isUnpublishMissing ? false : pkg[action].length > 0;

    _logger.logger.trace({
      user: user.name,
      name: pkg.name,
      hasGroups
    }, `fallback unpublish for @{name} has groups: @{hasGroups} for @{user}`);

    if (isUnpublishMissing || hasGroups === false) {
      return callback(null, undefined);
    }

    _logger.logger.trace({
      user: user.name,
      name: pkg.name,
      action,
      hasGroups
    }, `allow_action for @{action} for @{name} has groups: @{hasGroups} for @{user}`);

    return allow_action(action)(user, pkg, callback);
  };
}

function getDefaultPlugins() {
  return {
    authenticate(user, password, cb) {
      cb(_utils.ErrorCode.getForbidden(_constants.API_ERROR.BAD_USERNAME_PASSWORD));
    },

    add_user(user, password, cb) {
      return cb(_utils.ErrorCode.getConflict(_constants.API_ERROR.BAD_USERNAME_PASSWORD));
    },

    // FIXME: allow_action and allow_publish should be in the @verdaccio/types
    // @ts-ignore
    allow_access: allow_action('access'),
    // @ts-ignore
    allow_publish: allow_action('publish'),
    allow_unpublish: handleSpecialUnpublish()
  };
}

function createSessionToken() {
  const tenHoursTime = 10 * 60 * 60 * 1000;
  return {
    // npmjs.org sets 10h expire
    expires: new Date(Date.now() + tenHoursTime)
  };
}

const defaultWebTokenOptions = {
  sign: {
    // The expiration token for the website is 7 days
    expiresIn: _constants.TIME_EXPIRATION_7D
  },
  verify: {}
};
const defaultApiTokenConf = {
  legacy: true
};
const defaultSecurity = {
  web: defaultWebTokenOptions,
  api: defaultApiTokenConf
};
exports.defaultSecurity = defaultSecurity;

function getSecurity(config) {
  if (_lodash.default.isNil(config.security) === false) {
    return _lodash.default.merge(defaultSecurity, config.security);
  }

  return defaultSecurity;
}

function getAuthenticatedMessage(user) {
  return `you are authenticated as '${user}'`;
}

function buildUserBuffer(name, password) {
  return Buffer.from(`${name}:${password}`, 'utf8');
}

function isAESLegacy(security) {
  const {
    legacy,
    jwt
  } = security.api;
  return _lodash.default.isNil(legacy) === false && _lodash.default.isNil(jwt) && legacy === true;
}

async function getApiToken(auth, config, remoteUser, aesPassword) {
  const security = getSecurity(config);

  if (isAESLegacy(security)) {
    // fallback all goes to AES encryption
    return await new Promise(resolve => {
      resolve(auth.aesEncrypt(buildUserBuffer(remoteUser.name, aesPassword)).toString('base64'));
    });
  } else {
    // i am wiling to use here _.isNil but flow does not like it yet.
    const {
      jwt
    } = security.api;

    if (jwt && jwt.sign) {
      return await auth.jwtEncrypt(remoteUser, jwt.sign);
    } else {
      return await new Promise(resolve => {
        resolve(auth.aesEncrypt(buildUserBuffer(remoteUser.name, aesPassword)).toString('base64'));
      });
    }
  }
}

function parseAuthTokenHeader(authorizationHeader) {
  const parts = authorizationHeader.split(' ');
  const [scheme, token] = parts;
  return {
    scheme,
    token
  };
}

function parseBasicPayload(credentials) {
  const index = credentials.indexOf(':');

  if (index < 0) {
    return;
  }

  const user = credentials.slice(0, index);
  const password = credentials.slice(index + 1);
  return {
    user,
    password
  };
}

function parseAESCredentials(authorizationHeader, secret) {
  const {
    scheme,
    token
  } = parseAuthTokenHeader(authorizationHeader); // basic is deprecated and should not be enforced

  if (scheme.toUpperCase() === _constants.TOKEN_BASIC.toUpperCase()) {
    const credentials = (0, _utils.convertPayloadToBase64)(token).toString();
    return credentials;
  } else if (scheme.toUpperCase() === _constants.TOKEN_BEARER.toUpperCase()) {
    const tokenAsBuffer = (0, _utils.convertPayloadToBase64)(token);
    const credentials = (0, _cryptoUtils.aesDecrypt)(tokenAsBuffer, secret).toString('utf8');
    return credentials;
  }
}

const expireReasons = ['JsonWebTokenError', 'TokenExpiredError'];
exports.expireReasons = expireReasons;

function verifyJWTPayload(token, secret) {
  try {
    const payload = (0, _cryptoUtils.verifyPayload)(token, secret);
    return payload;
  } catch (error) {
    // #168 this check should be removed as soon AES encrypt is removed.
    if (expireReasons.includes(error.name)) {
      // it might be possible the jwt configuration is enabled and
      // old tokens fails still remains in usage, thus
      // we return an anonymous user to force log in.
      return createAnonymousRemoteUser();
    } else {
      throw _utils.ErrorCode.getCode(_constants.HTTP_STATUS.UNAUTHORIZED, error.message);
    }
  }
}

function isAuthHeaderValid(authorization) {
  return authorization.split(' ').length === 2;
}

function getMiddlewareCredentials(security, secret, authorizationHeader) {
  if (isAESLegacy(security)) {
    const credentials = parseAESCredentials(authorizationHeader, secret);

    if (!credentials) {
      return;
    }

    const parsedCredentials = parseBasicPayload(credentials);

    if (!parsedCredentials) {
      return;
    }

    return parsedCredentials;
  } else {
    const {
      scheme,
      token
    } = parseAuthTokenHeader(authorizationHeader);

    if (_lodash.default.isString(token) && scheme.toUpperCase() === _constants.TOKEN_BEARER.toUpperCase()) {
      return verifyJWTPayload(token, secret);
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvYXV0aC11dGlscy50cyJdLCJuYW1lcyI6WyJ2YWxpZGF0ZVBhc3N3b3JkIiwicGFzc3dvcmQiLCJtaW5MZW5ndGgiLCJERUZBVUxUX01JTl9MSU1JVF9QQVNTV09SRCIsImxlbmd0aCIsImNyZWF0ZVJlbW90ZVVzZXIiLCJuYW1lIiwicGx1Z2luR3JvdXBzIiwiaXNHcm91cFZhbGlkIiwiQXJyYXkiLCJpc0FycmF5IiwiZ3JvdXBzIiwiY29uY2F0IiwiUk9MRVMiLCIkQUxMIiwiJEFVVEgiLCJERVBSRUNBVEVEX0FMTCIsIkRFUFJFQ0FURURfQVVUSCIsIkFMTCIsInJlYWxfZ3JvdXBzIiwiY3JlYXRlQW5vbnltb3VzUmVtb3RlVXNlciIsInVuZGVmaW5lZCIsIiRBTk9OWU1PVVMiLCJERVBSRUNBVEVEX0FOT05ZTU9VUyIsImFsbG93X2FjdGlvbiIsImFjdGlvbiIsInVzZXIiLCJwa2ciLCJjYWxsYmFjayIsImxvZ2dlciIsInRyYWNlIiwicmVtb3RlIiwiZ3JvdXBBY2Nlc3MiLCJoYXNQZXJtaXNzaW9uIiwic29tZSIsImdyb3VwIiwiaW5jbHVkZXMiLCJwa2dOYW1lIiwiRXJyb3JDb2RlIiwiZ2V0Rm9yYmlkZGVuIiwiZ2V0VW5hdXRob3JpemVkIiwiaGFuZGxlU3BlY2lhbFVucHVibGlzaCIsImlzVW5wdWJsaXNoTWlzc2luZyIsIl8iLCJpc05pbCIsImhhc0dyb3VwcyIsImdldERlZmF1bHRQbHVnaW5zIiwiYXV0aGVudGljYXRlIiwiY2IiLCJBUElfRVJST1IiLCJCQURfVVNFUk5BTUVfUEFTU1dPUkQiLCJhZGRfdXNlciIsImdldENvbmZsaWN0IiwiYWxsb3dfYWNjZXNzIiwiYWxsb3dfcHVibGlzaCIsImFsbG93X3VucHVibGlzaCIsImNyZWF0ZVNlc3Npb25Ub2tlbiIsInRlbkhvdXJzVGltZSIsImV4cGlyZXMiLCJEYXRlIiwibm93IiwiZGVmYXVsdFdlYlRva2VuT3B0aW9ucyIsInNpZ24iLCJleHBpcmVzSW4iLCJUSU1FX0VYUElSQVRJT05fN0QiLCJ2ZXJpZnkiLCJkZWZhdWx0QXBpVG9rZW5Db25mIiwibGVnYWN5IiwiZGVmYXVsdFNlY3VyaXR5Iiwid2ViIiwiYXBpIiwiZ2V0U2VjdXJpdHkiLCJjb25maWciLCJzZWN1cml0eSIsIm1lcmdlIiwiZ2V0QXV0aGVudGljYXRlZE1lc3NhZ2UiLCJidWlsZFVzZXJCdWZmZXIiLCJCdWZmZXIiLCJmcm9tIiwiaXNBRVNMZWdhY3kiLCJqd3QiLCJnZXRBcGlUb2tlbiIsImF1dGgiLCJyZW1vdGVVc2VyIiwiYWVzUGFzc3dvcmQiLCJQcm9taXNlIiwicmVzb2x2ZSIsImFlc0VuY3J5cHQiLCJ0b1N0cmluZyIsImp3dEVuY3J5cHQiLCJwYXJzZUF1dGhUb2tlbkhlYWRlciIsImF1dGhvcml6YXRpb25IZWFkZXIiLCJwYXJ0cyIsInNwbGl0Iiwic2NoZW1lIiwidG9rZW4iLCJwYXJzZUJhc2ljUGF5bG9hZCIsImNyZWRlbnRpYWxzIiwiaW5kZXgiLCJpbmRleE9mIiwic2xpY2UiLCJwYXJzZUFFU0NyZWRlbnRpYWxzIiwic2VjcmV0IiwidG9VcHBlckNhc2UiLCJUT0tFTl9CQVNJQyIsIlRPS0VOX0JFQVJFUiIsInRva2VuQXNCdWZmZXIiLCJleHBpcmVSZWFzb25zIiwidmVyaWZ5SldUUGF5bG9hZCIsInBheWxvYWQiLCJlcnJvciIsImdldENvZGUiLCJIVFRQX1NUQVRVUyIsIlVOQVVUSE9SSVpFRCIsIm1lc3NhZ2UiLCJpc0F1dGhIZWFkZXJWYWxpZCIsImF1dGhvcml6YXRpb24iLCJnZXRNaWRkbGV3YXJlQ3JlZGVudGlhbHMiLCJwYXJzZWRDcmVkZW50aWFscyIsImlzU3RyaW5nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBSUE7O0FBRUE7Ozs7QUFFTyxTQUFTQSxnQkFBVCxDQUEwQkMsUUFBMUIsRUFBNENDLFNBQWlCLEdBQUdDLHFDQUFoRSxFQUFxRztBQUMxRyxTQUFPLE9BQU9GLFFBQVAsS0FBb0Is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c0Q2QixNQUF0RCxFQUFzRVgsbUJBQXRFLEVBQTBIO0FBQy9ILE1BQUlaLFdBQVcsQ0FBQ04sUUFBRCxDQUFmLEVBQTJCO0FBQ3pCLFVBQU13QixXQUFXLEdBQUdJLG1CQUFtQixDQUFDVixtQkFBRCxFQUFzQlcsTUFBdEIsQ0FBdkM7O0FBQ0EsUUFBSSxDQUFDTCxXQUFMLEVBQWtCO0FBQ2hCO0FBQ0Q7O0FBRUQsVUFBTXFCLGlCQUFpQixHQUFHdEIsaUJBQWlCLENBQUNDLFdBQUQsQ0FBM0M7O0FBQ0EsUUFBSSxDQUFDcUIsaUJBQUwsRUFBd0I7QUFDdEI7QUFDRDs7QUFFRCxXQUFPQSxpQkFBUDtBQUNELEdBWkQsTUFZTztBQUNMLFVBQU07QUFBRXhCLE1BQUFBLE1BQUY7QUFBVUMsTUFBQUE7QUFBVixRQUFvQkwsb0JBQW9CLENBQUNDLG1CQUFELENBQTlDOztBQUVBLFFBQUloRCxnQkFBRTRFLFFBQUYsQ0FBV3hCLEtBQVgsS0FBcUJELE1BQU0sQ0FBQ1MsV0FBUCxPQUF5QkUsd0JBQWFGLFdBQWIsRUFBbEQsRUFBOEU7QUFDNUUsYUFBT0ssZ0JBQWdCLENBQUNiLEtBQUQsRUFBUU8sTUFBUixDQUF2QjtBQUNEO0FBQ0Y7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBjb252ZXJ0UGF5bG9hZFRvQmFzZTY0LCBFcnJvckNvZGUgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IEFQSV9FUlJPUiwgSFRUUF9TVEFUVVMsIFJPTEVTLCBUSU1FX0VYUElSQVRJT05fN0QsIFRPS0VOX0JBU0lDLCBUT0tFTl9CRUFSRVIsIERFRkFVTFRfTUlOX0xJTUlUX1BBU1NXT1JEIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuXG5pbXBvcnQgeyBSZW1vdGVVc2VyLCBQYWNrYWdlLCBDYWxsYmFjaywgQ29uZmlnLCBTZWN1cml0eSwgQVBJVG9rZW5PcHRpb25zLCBKV1RPcHRpb25zLCBJUGx1Z2luQXV0aCB9IGZyb20gJ0B2ZXJkYWNjaW8vdHlwZXMnO1xuaW1wb3J0IHsgQ29va2llU2Vzc2lvblRva2VuLCBJQXV0aFdlYlVJLCBBdXRoTWlkZGxld2FyZVBheWxvYWQsIEF1dGhUb2tlbkhlYWRlciwgQmFzaWNQYXlsb2FkIH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xuaW1wb3J0IHsgYWVzRGVjcnlwdCwgdmVyaWZ5UGF5bG9hZCB9IGZyb20gJy4vY3J5cHRvLXV0aWxzJztcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vbGliL2xvZ2dlcic7XG5cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZVBhc3N3b3JkKHBhc3N3b3JkOiBzdHJpbmcsIG1pbkxlbmd0aDogbnVtYmVyID0gREVGQVVMVF9NSU5fTElNSVRfUEFTU1dPUkQpOiBib29sZWFuIHtcbiAgcmV0dXJuIHR5cGVvZiBwYXNzd29yZCA9PT0gJ3N0cmluZycgJiYgcGFzc3dvcmQubGVuZ3RoID49IG1pbkxlbmd0aDtcbn1cblxuLyoqXG4gKiBDcmVhdGUgYSBSZW1vdGVVc2VyIG9iamVjdFxuICogQHJldHVybiB7T2JqZWN0fSB7IG5hbWU6IHh4LCBwbHVnaW5Hcm91cHM6IFtdLCByZWFsX2dyb3VwczogW10gfVxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlUmVtb3RlVXNlcihuYW1lOiBzdHJpbmcsIHBsdWdpbkdyb3Vwczogc3RyaW5nW10pOiBSZW1vdGVVc2VyIHtcbiAgY29uc3QgaXNHcm91cFZhbGlkOiBib29sZWFuID0gQXJyYXkuaXNBcnJheShwbHVnaW5Hcm91cHMpO1xuICBjb25zdCBncm91cHMgPSAoaXNHcm91cFZhbGlkID8gcGx1Z2luR3JvdXBzIDogW10pLmNvbmNhdChbUk9MRVMuJEFMTCwgUk9MRVMuJEFVVEgsIFJPTEVTLkRFUFJFQ0FURURfQUxMLCBST0xFUy5ERVBSRUNBVEVEX0FVVEgsIFJPTEVTLkFMTF0pO1xuXG4gIHJldHVybiB7XG4gICAgbmFtZSxcbiAgICBncm91cHMsXG4gICAgcmVhbF9ncm91cHM6IHBsdWdpbkdyb3VwcyxcbiAgfTtcbn1cblxuLyoqXG4gKiBCdWlsZHMgYW4gYW5vbnltb3VzIHJlbW90ZSB1c2VyIGluIGNhc2Ugbm9uZSBpcyBsb2dnZWQgaW4uXG4gKiBAcmV0dXJuIHtPYmplY3R9IHsgbmFtZTogeHgsIGdyb3VwczogW10sIHJlYWxfZ3JvdXBzOiBbXSB9XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVBbm9ueW1vdXNSZW1vdGVVc2VyKCk6IFJlbW90ZVVzZXIge1xuICByZXR1cm4ge1xuICAgIG5hbWU6IHVuZGVmaW5lZCxcbiAgICAvLyBncm91cHMgd2l0aG91dCAnJCcgYXJlIGdvaW5nIHRvIGJlIGRlcHJlY2F0ZWQgZXZlbnR1YWxseVxuICAgIGdyb3VwczogW1JPTEVTLiRBTEwsIFJPTEVTLiRBTk9OWU1PVVMsIFJPTEVTLkRFUFJFQ0FURURfQUxMLCBST0xFUy5ERVBSRUNBVEVEX0FOT05ZTU9VU10sXG4gICAgcmVhbF9ncm91cHM6IFtdLFxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYWxsb3dfYWN0aW9uKGFjdGlvbjogc3RyaW5nKTogRnVuY3Rpb24ge1xuICByZXR1cm4gZnVuY3Rpb24odXNlcjogUmVtb3RlVXNlciwgcGtnOiBQYWNrYWdlLCBjYWxsYmFjazogQ2FsbGJhY2spOiB2b2lkIHtcbiAgICBsb2dnZXIudHJhY2Uoe3JlbW90ZTogdXNlci5uYW1lfSwgYFthdXRoL2FsbG93X2FjdGlvbl06IHVzZXI6IEB7dXNlci5uYW1lfWApO1xuICAgIGNvbnN0IHsgbmFtZSwgZ3JvdXBzIH0gPSB1c2VyO1xuICAgIGNvbnN0IGdyb3VwQWNjZXNzID0gcGtnW2FjdGlvbl07XG4gICAgY29uc3QgaGFzUGVybWlzc2lvbiA9IGdyb3VwQWNjZXNzLnNvbWUoZ3JvdXAgPT4gbmFtZSA9PT0gZ3JvdXAgfHwgZ3JvdXBzLmluY2x1ZGVzKGdyb3VwKSk7XG4gICAgbG9nZ2VyLnRyYWNlKHtwa2dOYW1lOiBwa2cubmFtZSwgaGFzUGVybWlzc2lvbiwgcmVtb3RlOiB1c2VyLm5hbWUsIGdyb3VwQWNjZXNzfSwgYFthdXRoL2FsbG93X2FjdGlvbl06IGhhc1Blcm1pc3Npb24/IEB7aGFzUGVybWlzc2lvbn0gZm9yIHVzZXI6IEB7dXNlcn1gKTtcblxuICAgIGlmIChoYXNQZXJtaXNzaW9uKSB7XG4gICAgICBsb2dnZXIudHJhY2Uoe3JlbW90ZTogdXNlci5uYW1lfSwgYGF1dGgvYWxsb3dfYWN0aW9uOiBhY2Nlc3MgZ3JhbnRlZCB0bzogQHt1c2VyfWApO1xuICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIHRydWUpO1xuICAgIH1cblxuICAgIGlmIChuYW1lKSB7XG4gICAgICBjYWxsYmFjayhFcnJvckNvZGUuZ2V0Rm9yYmlkZGVuKGB1c2VyICR7bmFtZX0gaXMgbm90IGFsbG93ZWQgdG8gJHthY3Rpb259IHBhY2thZ2UgJHtwa2cubmFtZX1gKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNhbGxiYWNrKEVycm9yQ29kZS5nZXRVbmF1dGhvcml6ZWQoYGF1dGhvcml6YXRpb24gcmVxdWlyZWQgdG8gJHthY3Rpb259IHBhY2thZ2UgJHtwa2cubmFtZX1gKSk7XG4gICAgfVxuICB9O1xufVxuXG4vKipcbiAqXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBoYW5kbGVTcGVjaWFsVW5wdWJsaXNoKCk6IGFueSB7XG4gIHJldHVybiBmdW5jdGlvbih1c2VyOiBSZW1vdGVVc2VyLCBwa2c6IFBhY2thZ2UsIGNhbGxiYWNrOiBDYWxsYmFjayk6IHZvaWQge1xuICAgIGNvbnN0IGFjdGlvbiA9ICd1bnB1Ymxpc2gnO1xuICAgIC8vIHZlcmlmeSB3aGV0aGVyIHRoZSB1bnB1Ymxpc2ggcHJvcCBoYXMgYmVlbiBkZWZpbmVkXG4gICAgY29uc3QgaXNVbnB1Ymxpc2hNaXNzaW5nOiBib29sZWFuID0gXy5pc05pbChwa2dbYWN0aW9uXSk7XG4gICAgY29uc3QgaGFzR3JvdXBzOiBib29sZWFuID0gaXNVbnB1Ymxpc2hNaXNzaW5nID8gZmFsc2UgOiBwa2dbYWN0aW9uXS5sZW5ndGggPiAwO1xuICAgIGxvZ2dlci50cmFjZSh7dXNlcjogdXNlci5uYW1lLCBuYW1lOiBwa2cubmFtZSwgaGFzR3JvdXBzfSwgYGZhbGxiYWNrIHVucHVibGlzaCBmb3IgQHtuYW1lfSBoYXMgZ3JvdXBzOiBAe2hhc0dyb3Vwc30gZm9yIEB7dXNlcn1gKTtcblxuICAgIGlmIChpc1VucHVibGlzaE1pc3NpbmcgfHwgaGFzR3JvdXBzID09PSBmYWxzZSkge1xuICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIHVuZGVmaW5lZCk7XG4gICAgfVxuXG4gICAgbG9nZ2VyLnRyYWNlKHt1c2VyOiB1c2VyLm5hbWUsIG5hbWU6IHBrZy5uYW1lLCBhY3Rpb24sIGhhc0dyb3Vwc30sIGBhbGxvd19hY3Rpb24gZm9yIEB7YWN0aW9ufSBmb3IgQHtuYW1lfSBoYXMgZ3JvdXBzOiBAe2hhc0dyb3Vwc30gZm9yIEB7dXNlcn1gKTtcbiAgICByZXR1cm4gYWxsb3dfYWN0aW9uKGFjdGlvbikodXNlciwgcGtnLCBjYWxsYmFjayk7XG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXREZWZhdWx0UGx1Z2lucygpOiBJUGx1Z2luQXV0aDxDb25maWc+IHtcbiAgcmV0dXJuIHtcbiAgICBhdXRoZW50aWNhdGUodXNlcjogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nLCBjYjogQ2FsbGJhY2spOiB2b2lkIHtcbiAgICAgIGNiKEVycm9yQ29kZS5nZXRGb3JiaWRkZW4oQVBJX0VSUk9SLkJBRF9VU0VSTkFNRV9QQVNTV09SRCkpO1xuICAgIH0sXG5cbiAgICBhZGRfdXNlcih1c2VyOiBzdHJpbmcsIHBhc3N3b3JkOiBzdHJpbmcsIGNiOiBDYWxsYmFjayk6IHZvaWQge1xuICAgICAgcmV0dXJuIGNiKEVycm9yQ29kZS5nZXRDb25mbGljdChBUElfRVJST1IuQkFEX1VTRVJOQU1FX1BBU1NXT1JEKSk7XG4gICAgfSxcblxuICAgIC8vIEZJWE1FOiBhbGxvd19hY3Rpb24gYW5kIGFsbG93X3B1Ymxpc2ggc2hvdWxkIGJlIGluIHRoZSBAdmVyZGFjY2lvL3R5cGVzXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGFsbG93X2FjY2VzczogYWxsb3dfYWN0aW9uKCdhY2Nlc3MnKSxcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgYWxsb3dfcHVibGlzaDogYWxsb3dfYWN0aW9uKCdwdWJsaXNoJyksXG4gICAgYWxsb3dfdW5wdWJsaXNoOiBoYW5kbGVTcGVjaWFsVW5wdWJsaXNoKCksXG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVTZXNzaW9uVG9rZW4oKTogQ29va2llU2Vzc2lvblRva2VuIHtcbiAgY29uc3QgdGVuSG91cnNUaW1lID0gMTAgKiA2MCAqIDYwICogMTAwMDtcblxuICByZXR1cm4ge1xuICAgIC8vIG5wbWpzLm9yZyBzZXRzIDEwaCBleHBpcmVcbiAgICBleHBpcmVzOiBuZXcgRGF0ZShEYXRlLm5vdygpICsgdGVuSG91cnNUaW1lKSxcbiAgfTtcbn1cblxuY29uc3QgZGVmYXVsdFdlYlRva2VuT3B0aW9uczogSldUT3B0aW9ucyA9IHtcbiAgc2lnbjoge1xuICAgIC8vIFRoZSBleHBpcmF0aW9uIHRva2VuIGZvciB0aGUgd2Vic2l0ZSBpcyA3IGRheXNcbiAgICBleHBpcmVzSW46IFRJTUVfRVhQSVJBVElPTl83RCxcbiAgfSxcbiAgdmVyaWZ5OiB7fSxcbn07XG5cbmNvbnN0IGRlZmF1bHRBcGlUb2tlbkNvbmY6IEFQSVRva2VuT3B0aW9ucyA9IHtcbiAgbGVnYWN5OiB0cnVlLFxufTtcblxuZXhwb3J0IGNvbnN0IGRlZmF1bHRTZWN1cml0eTogU2VjdXJpdHkgPSB7XG4gIHdlYjogZGVmYXVsdFdlYlRva2VuT3B0aW9ucyxcbiAgYXBpOiBkZWZhdWx0QXBpVG9rZW5Db25mLFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGdldFNlY3VyaXR5KGNvbmZpZzogQ29uZmlnKTogU2VjdXJpdHkge1xuICBpZiAoXy5pc05pbChjb25maWcuc2VjdXJpdHkpID09PSBmYWxzZSkge1xuICAgIHJldHVybiBfLm1lcmdlKGRlZmF1bHRTZWN1cml0eSwgY29uZmlnLnNlY3VyaXR5KTtcbiAgfVxuXG4gIHJldHVybiBkZWZhdWx0U2VjdXJpdHk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRBdXRoZW50aWNhdGVkTWVzc2FnZSh1c2VyOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gYHlvdSBhcmUgYXV0aGVudGljYXRlZCBhcyAnJHt1c2VyfSdgO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRVc2VyQnVmZmVyKG5hbWU6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZyk6IEJ1ZmZlciB7XG4gIHJldHVybiBCdWZmZXIuZnJvbShgJHtuYW1lfToke3Bhc3N3b3JkfWAsICd1dGY4Jyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0FFU0xlZ2FjeShzZWN1cml0eTogU2VjdXJpdHkpOiBib29sZWFuIHtcbiAgY29uc3QgeyBsZWdhY3ksIGp3dCB9ID0gc2VjdXJpdHkuYXBpO1xuXG4gIHJldHVybiBfLmlzTmlsKGxlZ2FjeSkgPT09IGZhbHNlICYmIF8uaXNOaWwoand0KSAmJiBsZWdhY3kgPT09IHRydWU7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRBcGlUb2tlbihhdXRoOiBJQXV0aFdlYlVJLCBjb25maWc6IENvbmZpZywgcmVtb3RlVXNlcjogUmVtb3RlVXNlciwgYWVzUGFzc3dvcmQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gIGNvbnN0IHNlY3VyaXR5OiBTZWN1cml0eSA9IGdldFNlY3VyaXR5KGNvbmZpZyk7XG5cbiAgaWYgKGlzQUVTTGVnYWN5KHNlY3VyaXR5KSkge1xuICAgIC8vIGZhbGxiYWNrIGFsbCBnb2VzIHRvIEFFUyBlbmNyeXB0aW9uXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKTogdm9pZCA9PiB7XG4gICAgICByZXNvbHZlKGF1dGguYWVzRW5jcnlwdChidWlsZFVzZXJCdWZmZXIocmVtb3RlVXNlci5uYW1lIGFzIHN0cmluZywgYWVzUGFzc3dvcmQpKS50b1N0cmluZygnYmFzZTY0JykpO1xuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIC8vIGkgYW0gd2lsaW5nIHRvIHVzZSBoZXJlIF8uaXNOaWwgYnV0IGZsb3cgZG9lcyBub3QgbGlrZSBpdCB5ZXQuXG4gICAgY29uc3QgeyBqd3QgfSA9IHNlY3VyaXR5LmFwaTtcblxuICAgIGlmIChqd3QgJiYgand0LnNpZ24pIHtcbiAgICAgIHJldHVybiBhd2FpdCBhdXRoLmp3dEVuY3J5cHQocmVtb3RlVXNlciwgand0LnNpZ24pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpOiB2b2lkID0+IHtcbiAgICAgICAgcmVzb2x2ZShhdXRoLmFlc0VuY3J5cHQoYnVpbGRVc2VyQnVmZmVyKHJlbW90ZVVzZXIubmFtZSBhcyBzdHJpbmcsIGFlc1Bhc3N3b3JkKSkudG9TdHJpbmcoJ2Jhc2U2NCcpKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VBdXRoVG9rZW5IZWFkZXIoYXV0aG9yaXphdGlvbkhlYWRlcjogc3RyaW5nKTogQXV0aFRva2VuSGVhZGVyIHtcbiAgY29uc3QgcGFydHMgPSBhdXRob3JpemF0aW9uSGVhZGVyLnNwbGl0KCcgJyk7XG4gIGNvbnN0IFtzY2hlbWUsIHRva2VuXSA9IHBhcnRzO1xuXG4gIHJldHVybiB7IHNjaGVtZSwgdG9rZW4gfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlQmFzaWNQYXlsb2FkKGNyZWRlbnRpYWxzOiBzdHJpbmcpOiBCYXNpY1BheWxvYWQge1xuICBjb25zdCBpbmRleCA9IGNyZWRlbnRpYWxzLmluZGV4T2YoJzonKTtcbiAgaWYgKGluZGV4IDwgMCkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHVzZXI6IHN0cmluZyA9IGNyZWRlbnRpYWxzLnNsaWNlKDAsIGluZGV4KTtcbiAgY29uc3QgcGFzc3dvcmQ6IHN0cmluZyA9IGNyZWRlbnRpYWxzLnNsaWNlKGluZGV4ICsgMSk7XG5cbiAgcmV0dXJuIHsgdXNlciwgcGFzc3dvcmQgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlQUVTQ3JlZGVudGlhbHMoYXV0aG9yaXphdGlvbkhlYWRlcjogc3RyaW5nLCBzZWNyZXQ6IHN0cmluZykge1xuICBjb25zdCB7IHNjaGVtZSwgdG9rZW4gfSA9IHBhcnNlQXV0aFRva2VuSGVhZGVyKGF1dGhvcml6YXRpb25IZWFkZXIpO1xuXG4gIC8vIGJhc2ljIGlzIGRlcHJlY2F0ZWQgYW5kIHNob3VsZCBub3QgYmUgZW5mb3JjZWRcbiAgaWYgKHNjaGVtZS50b1VwcGVyQ2FzZSgpID09PSBUT0tFTl9CQVNJQy50b1VwcGVyQ2FzZSgpKSB7XG4gICAgY29uc3QgY3JlZGVudGlhbHMgPSBjb252ZXJ0UGF5bG9hZFRvQmFzZTY0KHRva2VuKS50b1N0cmluZygpO1xuXG4gICAgcmV0dXJuIGNyZWRlbnRpYWxzO1xuICB9IGVsc2UgaWYgKHNjaGVtZS50b1VwcGVyQ2FzZSgpID09PSBUT0tFTl9CRUFSRVIudG9VcHBlckNhc2UoKSkge1xuICAgIGNvbnN0IHRva2VuQXNCdWZmZXIgPSBjb252ZXJ0UGF5bG9hZFRvQmFzZTY0KHRva2VuKTtcbiAgICBjb25zdCBjcmVkZW50aWFscyA9IGFlc0RlY3J5cHQodG9rZW5Bc0J1ZmZlciwgc2VjcmV0KS50b1N0cmluZygndXRmOCcpO1xuXG4gICAgcmV0dXJuIGNyZWRlbnRpYWxzO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBleHBpcmVSZWFzb25zOiBzdHJpbmdbXSA9IFsnSnNvbldlYlRva2VuRXJyb3InLCAnVG9rZW5FeHBpcmVkRXJyb3InXTtcblxuZXhwb3J0IGZ1bmN0aW9uIHZlcmlmeUpXVFBheWxvYWQodG9rZW46IHN0cmluZywgc2VjcmV0OiBzdHJpbmcpOiBSZW1vdGVVc2VyIHtcbiAgdHJ5IHtcbiAgICBjb25zdCBwYXlsb2FkOiBSZW1vdGVVc2VyID0gdmVyaWZ5UGF5bG9hZCh0b2tlbiwgc2VjcmV0KTtcblxuICAgIHJldHVybiBwYXlsb2FkO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIC8vICMxNjggdGhpcyBjaGVjayBzaG91bGQgYmUgcmVtb3ZlZCBhcyBzb29uIEFFUyBlbmNyeXB0IGlzIHJlbW92ZWQuXG4gICAgaWYgKGV4cGlyZVJlYXNvbnMuaW5jbHVkZXMoZXJyb3IubmFtZSkpIHtcbiAgICAgIC8vIGl0IG1pZ2h0IGJlIHBvc3NpYmxlIHRoZSBqd3QgY29uZmlndXJhdGlvbiBpcyBlbmFibGVkIGFuZFxuICAgICAgLy8gb2xkIHRva2VucyBmYWlscyBzdGlsbCByZW1haW5zIGluIHVzYWdlLCB0aHVzXG4gICAgICAvLyB3ZSByZXR1cm4gYW4gYW5vbnltb3VzIHVzZXIgdG8gZm9yY2UgbG9nIGluLlxuICAgICAgcmV0dXJuIGNyZWF0ZUFub255bW91c1JlbW90ZVVzZXIoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgRXJyb3JDb2RlLmdldENvZGUoSFRUUF9TVEFUVVMuVU5BVVRIT1JJWkVELCBlcnJvci5tZXNzYWdlKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzQXV0aEhlYWRlclZhbGlkKGF1dGhvcml6YXRpb246IHN0cmluZyk6IGJvb2xlYW4ge1xuICByZXR1cm4gYXV0aG9yaXphdGlvbi5zcGxpdCgnICcpLmxlbmd0aCA9PT0gMjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE1pZGRsZXdhcmVDcmVkZW50aWFscyhzZWN1cml0eTogU2VjdXJpdHksIHNlY3JldDogc3RyaW5nLCBhdXRob3JpemF0aW9uSGVhZGVyOiBzdHJpbmcpOiBBdXRoTWlkZGxld2FyZVBheWxvYWQge1xuICBpZiAoaXNBRVNMZWdhY3koc2VjdXJpdHkpKSB7XG4gICAgY29uc3QgY3JlZGVudGlhbHMgPSBwYXJzZUFFU0NyZWRlbnRpYWxzKGF1dGhvcml6YXRpb25IZWFkZXIsIHNlY3JldCk7XG4gICAgaWYgKCFjcmVkZW50aWFscykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHBhcnNlZENyZWRlbnRpYWxzID0gcGFyc2VCYXNpY1BheWxvYWQoY3JlZGVudGlhbHMpO1xuICAgIGlmICghcGFyc2VkQ3JlZGVudGlhbHMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICByZXR1cm4gcGFyc2VkQ3JlZGVudGlhbHM7XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgeyBzY2hlbWUsIHRva2VuIH0gPSBwYXJzZUF1dGhUb2tlbkhlYWRlcihhdXRob3JpemF0aW9uSGVhZGVyKTtcblxuICAgIGlmIChfLmlzU3RyaW5nKHRva2VuKSAmJiBzY2hlbWUudG9VcHBlckNhc2UoKSA9PT0gVE9LRU5fQkVBUkVSLnRvVXBwZXJDYXNlKCkpIHtcbiAgICAgIHJldHVybiB2ZXJpZnlKV1RQYXlsb2FkKHRva2VuLCBzZWNyZXQpO1xuICAgIH1cbiAgfVxufVxuIl19