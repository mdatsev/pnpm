"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

var _lodash = _interopRequireDefault(require("lodash"));

var _constants = require("../../../../lib/constants");

var _utils = require("../../../../lib/utils");

var _authUtils = require("../../../../lib/auth-utils");

var _cryptoUtils = require("../../../../lib/crypto-utils");

var _logger = require("../../../../lib/logger");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function normalizeToken(token) {
  return _objectSpread({}, token, {
    created: new Date(token.created).toISOString()
  });
}

; // https://github.com/npm/npm-profile/blob/latest/lib/index.js

function _default(route, auth, storage, config) {
  route.get('/-/npm/v1/tokens', async function (req, res, next) {
    const {
      name
    } = req.remote_user;

    if (_lodash.default.isNil(name) === false) {
      try {
        const tokens = await storage.readTokens({
          user: name
        });
        const totalTokens = tokens.length;

        _logger.logger.debug({
          totalTokens
        }, 'token list retrieved: @{totalTokens}');

        res.status(_constants.HTTP_STATUS.OK);
        return next({
          objects: tokens.map(normalizeToken),
          urls: {
            next: '' // TODO: pagination?

          }
        });
      } catch (error) {
        _logger.logger.error({
          error: error.msg
        }, 'token list has failed: @{error}');

        return next(_utils.ErrorCode.getCode(_constants.HTTP_STATUS.INTERNAL_ERROR, error.message));
      }
    } else {
      return next(_utils.ErrorCode.getUnauthorized());
    }
  });
  route.post('/-/npm/v1/tokens', function (req, res, next) {
    const {
      password,
      readonly,
      cidr_whitelist
    } = req.body;
    const {
      name
    } = req.remote_user;

    if (!_lodash.default.isBoolean(readonly) || !_lodash.default.isArray(cidr_whitelist)) {
      return next(_utils.ErrorCode.getCode(_constants.HTTP_STATUS.BAD_DATA, _constants.SUPPORT_ERRORS.PARAMETERS_NOT_VALID));
    }

    auth.authenticate(name, password, async (err, user) => {
      if (err) {
        const errorCode = err.message ? _constants.HTTP_STATUS.UNAUTHORIZED : _constants.HTTP_STATUS.INTERNAL_ERROR;
        return next(_utils.ErrorCode.getCode(errorCode, err.message));
      } else {
        req.remote_user = user;

        if (!_lodash.default.isFunction(storage.saveToken)) {
          return next(_utils.ErrorCode.getCode(_constants.HTTP_STATUS.NOT_IMPLEMENTED, _constants.SUPPORT_ERRORS.STORAGE_NOT_IMPLEMENT));
        }

        try {
          const token = await (0, _authUtils.getApiToken)(auth, config, user, password);
          const key = (0, _cryptoUtils.stringToMD5)(token); // TODO: use a utility here

          const maskedToken = (0, _utils.mask)(token, 5);
          const created = new Date().getTime();
          /**
           * cidr_whitelist: is not being used, we pass it through
           * token: we do not store the real token (it is generated once and retrieved to the user), just a mask of it.
           */

          const saveToken = {
            user: name,
            token: maskedToken,
            key,
            cidr: cidr_whitelist,
            readonly,
            created
          };
          await storage.saveToken(saveToken);

          _logger.logger.debug({
            key,
            name
          }, 'token @{key} was created for user @{name}');

          return next(normalizeToken({
            token,
            user: name,
            key: saveToken.key,
            cidr: cidr_whitelist,
            readonly,
            created: saveToken.created
          }));
        } catch (error) {
          _logger.logger.error({
            error: error.msg
          }, 'token creation has failed: @{error}');

          return next(_utils.ErrorCode.getCode(_constants.HTTP_STATUS.INTERNAL_ERROR, error.message));
        }
      }
    });
  });
  route.delete('/-/npm/v1/tokens/token/:tokenKey', async (req, res, next) => {
    const {
      params: {
        tokenKey
      }
    } = req;
    const {
      name
    } = req.remote_user;

    if (_lodash.default.isNil(name) === false) {
      _logger.logger.debug({
        name
      }, '@{name} has requested remove a token');

      try {
        await storage.deleteToken(name, tokenKey);

        _logger.logger.info({
          tokenKey,
          name
        }, 'token id @{tokenKey} was revoked for user @{name}');

        return next({});
      } catch (error) {
        _logger.logger.error({
          error: error.msg
        }, 'token creation has failed: @{error}');

        return next(_utils.ErrorCode.getCode(_constants.HTTP_STATUS.INTERNAL_ERROR, error.message));
      }
    } else {
      return next(_utils.ErrorCode.getUnauthorized());
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9hcGkvZW5kcG9pbnQvYXBpL3YxL3Rva2VuLnRzIl0sIm5hbWVzIjpbIm5vcm1hbGl6ZVRva2VuIiwidG9rZW4iLCJjcmVhdGVkIiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwicm91dGUiLCJhdXRoIiwic3RvcmFnZSIsImNvbmZpZyIsImdldCIsInJlcSIsInJlcyIsIm5leHQiLCJuYW1lIiwicmVtb3RlX3VzZXIiLCJfIiwiaXNOaWwiLCJ0b2tlbnMiLCJyZWFkVG9rZW5zIiwidXNlciIsInRvdGFsVG9rZW5zIiwibGVuZ3RoIiwibG9nZ2VyIiwiZGVidWciLCJzdGF0dXMiLCJIVFRQX1NUQVRVUyIsIk9LIiwib2JqZWN0cyIsIm1hcCIsInVybHMiLCJlcnJvciIsIm1zZyIsIkVycm9yQ29kZSIsImdldENvZGUiLCJJTlRFUk5BTF9FUlJPUiIsIm1lc3NhZ2UiLCJnZXRVbmF1dGhvcml6ZWQiLCJwb3N0IiwicGFzc3dvcmQiLCJyZWFkb25seSIsImNpZHJfd2hpdGVsaXN0IiwiYm9keSIsImlzQm9vbGVhbiIsImlzQXJyYXkiLCJCQURfREFUQSIsIlNVUFBPUlRfRVJST1JTIiwiUEFSQU1FVEVSU19OT1RfVkFMSUQiLCJhdXRoZW50aWNhdGUiLCJlcnIiLCJlcnJvckNvZGUiLCJVTkFVVEhPUklaRUQiLCJpc0Z1bmN0aW9uIiwic2F2ZVRva2VuIiwiTk9UX0lNUExFTUVOVEVEIiwiU1RPUkFHRV9OT1RfSU1QTEVNRU5UIiwia2V5IiwibWFza2VkVG9rZW4iLCJnZXRUaW1lIiwiY2lkciIsImRlbGV0ZSIsInBhcmFtcyIsInRva2VuS2V5IiwiZGVsZXRlVG9rZW4iLCJpbmZvIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7QUFVQSxTQUFTQSxjQUFULENBQXdCQyxLQUF4QixFQUFzRDtBQUNyRCwyQkFDSUEsS0FESjtBQUVDQyxJQUFBQSxPQUFPLEVBQUUs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QU9uQixJQUFJLENBQUNvQixpQkFBVUMsT0FBVixDQUFrQlIsdUJBQVlTLGNBQTlCLEVBQThDSixLQUFLLENBQUNLLE9BQXBELENBQUQsQ0FBWDtBQUNBO0FBQ0QsS0FWRCxNQVVPO0FBQ04sYUFBT3ZCLElBQUksQ0FBQ29CLGlCQUFVSSxlQUFWLEVBQUQsQ0FBWDtBQUNBO0FBQ0QsR0FqQkQ7QUFrQkEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgSFRUUF9TVEFUVVMsIFNVUFBPUlRfRVJST1JTIH0gZnJvbSAnLi4vLi4vLi4vLi4vbGliL2NvbnN0YW50cyc7XG5pbXBvcnQge0Vycm9yQ29kZSwgbWFza30gZnJvbSAnLi4vLi4vLi4vLi4vbGliL3V0aWxzJztcbmltcG9ydCB7IGdldEFwaVRva2VuIH0gZnJvbSAnLi4vLi4vLi4vLi4vbGliL2F1dGgtdXRpbHMnO1xuaW1wb3J0IHsgc3RyaW5nVG9NRDUgfSBmcm9tICcuLi8uLi8uLi8uLi9saWIvY3J5cHRvLXV0aWxzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uLy4uLy4uLy4uL2xpYi9sb2dnZXInO1xuXG5pbXBvcnQgeyBSZXNwb25zZSwgUm91dGVyIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyROZXh0RnVuY3Rpb25WZXIsICRSZXF1ZXN0RXh0ZW5kLCBJQXV0aCwgSVN0b3JhZ2VIYW5kbGVyfSBmcm9tICcuLi8uLi8uLi8uLi8uLi90eXBlcyc7XG5pbXBvcnQgeyBDb25maWcsIFJlbW90ZVVzZXIsIFRva2VuIH0gZnJvbSAnQHZlcmRhY2Npby90eXBlcyc7XG5cbmV4cG9ydCB0eXBlIE5vcm1hbGl6ZVRva2VuID0gVG9rZW4gJiB7XG5cdGNyZWF0ZWQ6IHN0cmluZztcbn07XG5cbmZ1bmN0aW9uIG5vcm1hbGl6ZVRva2VuKHRva2VuOiBUb2tlbik6IE5vcm1hbGl6ZVRva2VuIHtcblx0cmV0dXJuIHtcblx0XHQuLi50b2tlbixcblx0XHRjcmVhdGVkOiBuZXcgRGF0ZSh0b2tlbi5jcmVhdGVkKS50b0lTT1N0cmluZygpLFxuXHR9O1xufTtcblxuLy8gaHR0cHM6Ly9naXRodWIuY29tL25wbS9ucG0tcHJvZmlsZS9ibG9iL2xhdGVzdC9saWIvaW5kZXguanNcbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uKHJvdXRlOiBSb3V0ZXIsIGF1dGg6IElBdXRoLCBzdG9yYWdlOiBJU3RvcmFnZUhhbmRsZXIsIGNvbmZpZzogQ29uZmlnKTogdm9pZCB7XG5cdHJvdXRlLmdldCgnLy0vbnBtL3YxL3Rva2VucycsIGFzeW5jIGZ1bmN0aW9uKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogUmVzcG9uc2UsIG5leHQ6ICROZXh0RnVuY3Rpb25WZXIpIHtcblx0XHRjb25zdCB7IG5hbWUgfSA9IHJlcS5yZW1vdGVfdXNlcjtcblxuXHRcdGlmIChfLmlzTmlsKG5hbWUpID09PSBmYWxzZSkge1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0Y29uc3QgdG9rZW5zID0gYXdhaXQgc3RvcmFnZS5yZWFkVG9rZW5zKHt1c2VyOiBuYW1lfSk7XG5cdFx0XHRcdGNvbnN0IHRvdGFsVG9rZW5zID0gdG9rZW5zLmxlbmd0aDtcblx0XHRcdFx0bG9nZ2VyLmRlYnVnKHt0b3RhbFRva2Vuc30sICd0b2tlbiBsaXN0IHJldHJpZXZlZDogQHt0b3RhbFRva2Vuc30nKTtcblxuXHRcdFx0XHRyZXMuc3RhdHVzKEhUVFBfU1RBVFVTLk9LKTtcblx0XHRcdFx0cmV0dXJuIG5leHQoe1xuXHRcdFx0XHRcdG9iamVjdHM6IHRva2Vucy5tYXAobm9ybWFsaXplVG9rZW4pLFxuXHRcdFx0XHRcdHVybHM6IHtcblx0XHRcdFx0XHRcdG5leHQ6ICcnLCAvLyBUT0RPOiBwYWdpbmF0aW9uP1xuXHRcdFx0XHRcdH0sXG5cdFx0XHRcdH0pO1xuXHRcdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdFx0bG9nZ2VyLmVycm9yKHsgZXJyb3I6IGVycm9yLm1zZyB9LCAndG9rZW4gbGlzdCBoYXMgZmFpbGVkOiBAe2Vycm9yfScpO1xuXHRcdFx0XHRyZXR1cm4gbmV4dChFcnJvckNvZGUuZ2V0Q29kZShIVFRQX1NUQVRVUy5JTlRFUk5BTF9FUlJPUiwgZXJyb3IubWVzc2FnZSkpO1xuXHRcdFx0fVxuXHRcdH0gZWxzZSB7XG5cdFx0XHRyZXR1cm4gbmV4dChFcnJvckNvZGUuZ2V0VW5hdXRob3JpemVkKCkpO1xuXHRcdH1cblx0fSk7XG5cblx0cm91dGUucG9zdCgnLy0vbnBtL3YxL3Rva2VucycsIGZ1bmN0aW9uKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogUmVzcG9uc2UsIG5leHQ6ICROZXh0RnVuY3Rpb25WZXIpIHtcblx0XHRjb25zdCB7IHBhc3N3b3JkLCByZWFkb25seSwgY2lkcl93aGl0ZWxpc3QgfSA9IHJlcS5ib2R5O1xuXHRcdGNvbnN0IHsgbmFtZSB9ID0gcmVxLnJlbW90ZV91c2VyO1xuXG5cdFx0aWYgKCFfLmlzQm9vbGVhbihyZWFkb25seSkgfHwgIV8uaXNBcnJheShjaWRyX3doaXRlbGlzdCkpIHtcblx0XHRcdHJldHVybiBuZXh0KEVycm9yQ29kZS5nZXRDb2RlKEhUVFBfU1RBVFVTLkJBRF9EQVRBLCBTVVBQT1JUX0VSUk9SUy5QQVJBTUVURVJTX05PVF9WQUxJRCkpO1xuXHRcdH1cblxuXHRcdGF1dGguYXV0aGVudGljYXRlKG5hbWUsIHBhc3N3b3JkLCBhc3luYyAoZXJyLCB1c2VyOiBSZW1vdGVVc2VyKSA9PiB7XG5cdFx0XHRpZiAoZXJyKSB7XG5cdFx0XHRcdGNvbnN0IGVycm9yQ29kZSA9IGVyci5tZXNzYWdlID8gSFRUUF9TVEFUVVMuVU5BVVRIT1JJWkVEIDogSFRUUF9TVEFUVVMuSU5URVJOQUxfRVJST1I7XG5cdFx0XHRcdHJldHVybiBuZXh0KEVycm9yQ29kZS5nZXRDb2RlKGVycm9yQ29kZSwgZXJyLm1lc3NhZ2UpKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHJlcS5yZW1vdGVfdXNlciA9IHVzZXI7XG5cblx0XHRcdFx0aWYgKCFfLmlzRnVuY3Rpb24oc3RvcmFnZS5zYXZlVG9rZW4pKSB7XG5cdFx0XHRcdFx0cmV0dXJuIG5leHQoRXJyb3JDb2RlLmdldENvZGUoSFRUUF9TVEFUVVMuTk9UX0lNUExFTUVOVEVELCBTVVBQT1JUX0VSUk9SUy5TVE9SQUdFX05PVF9JTVBMRU1FTlQpKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0Y29uc3QgdG9rZW4gPSBhd2FpdCBnZXRBcGlUb2tlbihhdXRoLCBjb25maWcsIHVzZXIsIHBhc3N3b3JkKTtcblx0XHRcdFx0XHRjb25zdCBrZXkgPSBzdHJpbmdUb01ENSh0b2tlbik7XG5cdFx0XHRcdFx0Ly8gVE9ETzogdXNlIGEgdXRpbGl0eSBoZXJlXG5cdFx0XHRcdFx0Y29uc3QgbWFza2VkVG9rZW4gPSBtYXNrKHRva2VuLCA1KTtcblx0XHRcdFx0XHRjb25zdCBjcmVhdGVkID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG5cblx0XHRcdFx0XHQvKipcblx0XHRcdFx0XHQgKiBjaWRyX3doaXRlbGlzdDogaXMgbm90IGJlaW5nIHVzZWQsIHdlIHBhc3MgaXQgdGhyb3VnaFxuXHRcdFx0XHRcdCAqIHRva2VuOiB3ZSBkbyBub3Qgc3RvcmUgdGhlIHJlYWwgdG9rZW4gKGl0IGlzIGdlbmVyYXRlZCBvbmNlIGFuZCByZXRyaWV2ZWQgdG8gdGhlIHVzZXIpLCBqdXN0IGEgbWFzayBvZiBpdC5cblx0XHRcdFx0XHQgKi9cblx0XHRcdFx0XHRjb25zdCBzYXZlVG9rZW46IFRva2VuID0ge1xuXHRcdFx0XHRcdFx0dXNlcjogbmFtZSxcblx0XHRcdFx0XHRcdHRva2VuOiBtYXNrZWRUb2tlbixcblx0XHRcdFx0XHRcdGtleSxcblx0XHRcdFx0XHRcdGNpZHI6IGNpZHJfd2hpdGVsaXN0LFxuXHRcdFx0XHRcdFx0cmVhZG9ubHksXG5cdFx0XHRcdFx0XHRjcmVhdGVkLFxuXHRcdFx0XHRcdH07XG5cblx0XHRcdFx0XHRhd2FpdCBzdG9yYWdlLnNhdmVUb2tlbihzYXZlVG9rZW4pO1xuXHRcdFx0XHRcdGxvZ2dlci5kZWJ1Zyh7IGtleSwgbmFtZSB9LCAndG9rZW4gQHtrZXl9IHdhcyBjcmVhdGVkIGZvciB1c2VyIEB7bmFtZX0nKTtcblx0XHRcdFx0XHRyZXR1cm4gbmV4dChub3JtYWxpemVUb2tlbih7XG5cdFx0XHRcdFx0XHR0b2tlbixcblx0XHRcdFx0XHRcdHVzZXI6IG5hbWUsXG5cdFx0XHRcdFx0XHRrZXk6IHNhdmVUb2tlbi5rZXksXG5cdFx0XHRcdFx0XHRjaWRyOiBjaWRyX3doaXRlbGlzdCxcblx0XHRcdFx0XHRcdHJlYWRvbmx5LFxuXHRcdFx0XHRcdFx0Y3JlYXRlZDogc2F2ZVRva2VuLmNyZWF0ZWQsXG5cdFx0XHRcdFx0fSkpO1xuXHRcdFx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0XHRcdGxvZ2dlci5lcnJvcih7IGVycm9yOiBlcnJvci5tc2cgfSwgJ3Rva2VuIGNyZWF0aW9uIGhhcyBmYWlsZWQ6IEB7ZXJyb3J9Jyk7XG5cdFx0XHRcdFx0cmV0dXJuIG5leHQoRXJyb3JDb2RlLmdldENvZGUoSFRUUF9TVEFUVVMuSU5URVJOQUxfRVJST1IsIGVycm9yLm1lc3NhZ2UpKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH0pO1xuXHR9KTtcblxuXHRyb3V0ZS5kZWxldGUoJy8tL25wbS92MS90b2tlbnMvdG9rZW4vOnRva2VuS2V5JywgYXN5bmMgKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogUmVzcG9uc2UsIG5leHQ6ICROZXh0RnVuY3Rpb25WZXIpID0+IHtcblx0XHRjb25zdCB7IHBhcmFtczogeyB0b2tlbktleSB9fSA9IHJlcTtcblx0XHRjb25zdCB7IG5hbWUgfSA9IHJlcS5yZW1vdGVfdXNlcjtcblxuXHRcdGlmIChfLmlzTmlsKG5hbWUpID09PSBmYWxzZSkge1xuXHRcdFx0bG9nZ2VyLmRlYnVnKHtuYW1lfSwgJ0B7bmFtZX0gaGFzIHJlcXVlc3RlZCByZW1vdmUgYSB0b2tlbicpO1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0YXdhaXQgc3RvcmFnZS5kZWxldGVUb2tlbihuYW1lLCB0b2tlbktleSk7XG5cdFx0XHRcdGxvZ2dlci5pbmZvKHsgdG9rZW5LZXksIG5hbWUgfSwgJ3Rva2VuIGlkIEB7dG9rZW5LZXl9IHdhcyByZXZva2VkIGZvciB1c2VyIEB7bmFtZX0nKTtcblx0XHRcdFx0cmV0dXJuIG5leHQoe30pO1xuXHRcdFx0fSBjYXRjaChlcnJvcikge1xuXHRcdFx0XHRsb2dnZXIuZXJyb3IoeyBlcnJvcjogZXJyb3IubXNnIH0sICd0b2tlbiBjcmVhdGlvbiBoYXMgZmFpbGVkOiBAe2Vycm9yfScpO1xuXHRcdFx0XHRyZXR1cm4gbmV4dChFcnJvckNvZGUuZ2V0Q29kZShIVFRQX1NUQVRVUy5JTlRFUk5BTF9FUlJPUiwgZXJyb3IubWVzc2FnZSkpO1xuXHRcdFx0fVxuXHRcdH0gZWxzZSB7XG5cdFx0XHRyZXR1cm4gbmV4dChFcnJvckNvZGUuZ2V0VW5hdXRob3JpemVkKCkpO1xuXHRcdH1cblx0fSk7XG59XG4iXX0=