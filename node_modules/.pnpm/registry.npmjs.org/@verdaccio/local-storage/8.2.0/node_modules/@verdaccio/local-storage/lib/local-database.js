"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash"));

var _async = _interopRequireDefault(require("async"));

var _mkdirp = _interopRequireDefault(require("mkdirp"));

var _level = _interopRequireDefault(require("level"));

var _lib = require("@verdaccio/commons-api/lib");

var _localFs = _interopRequireWildcard(require("./local-fs"));

var _pkgUtils = require("./pkg-utils");

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; if (obj != null) { var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const DEPRECATED_DB_NAME = '.sinopia-db.json';
const DB_NAME = '.verdaccio-db.json';
const TOKEN_DB_NAME = '.token-db';

/**
 * Handle local database.
 */
class LocalDatabase {
  /**
   * Load an parse the local json database.
   * @param {*} path the database path
   */
  constructor(config, logger) {
    _defineProperty(this, "path", void 0);

    _defineProperty(this, "logger", void 0);

    _defineProperty(this, "data", void 0);

    _defineProperty(this, "config", void 0);

    _defineProperty(this, "locked", void 0);

    _defineProperty(this, "tokenDb", void 0);

    this.config = config;
    this.path = this._buildStoragePath(config);
    this.logger = logger;
    this.locked = false;
    this.data = this._fetchLocalPackages();
    this.logger.trace({
      config: JSON.stringify(this.config, null, 4)
    }, '[local-storage]: configuration: @{config}');

    this._sync();
  }

  getSecret() {
    return Promise.resolve(this.data.secret);
  }

  setSecret(secret) {
    return new Promise(resolve => {
      this.data.secret = secret;
      resolve(this._sync());
    });
  }
  /**
   * Add a new element.
   * @param {*} name
   * @return {Error|*}
   */


  add(name, cb) {
    if (this.data.list.indexOf(name) === -1) {
      this.data.list.push(name);
      this.logger.debug({
        name
      }, '[local-storage]: the private package @{name} has been added');
      cb(this._sync());
    } else {
      cb(null);
    }
  }

  search(onPackage, onEnd, validateName) {
    const storages = this._getCustomPackageLocalStorages();

    this.logger.trace(`local-storage: [search]: ${JSON.stringify(storages)}`);

    const base = _path.default.dirname(this.config.self_path);

    const self = this;
    const storageKeys = Object.keys(storages);
    this.logger.trace(`local-storage: [search] base: ${base} keys ${storageKeys}`);

    _async.default.eachSeries(storageKeys, function (storage, cb) {
      const position = storageKeys.indexOf(storage);

      const base2 = _path.default.join(position !== 0 ? storageKeys[0] : '');

      const storagePath = _path.default.resolve(base, base2, storage);

      self.logger.trace({
        storagePath,
        storage
      }, 'local-storage: [search] search path: @{storagePath} : @{storage}');

      _fs.default.readdir(storagePath, (err, files) => {
        if (err) {
          return cb(err);
        }

        _async.default.eachSeries(files, function (file, cb) {
          self.logger.trace({
            file
          }, 'local-storage: [search] search file path: @{file}');

          if (storageKeys.includes(file)) {
            return cb();
          }

          if (file.match(/^@/)) {
            // scoped
            const fileLocation = _path.default.resolve(base, storage, file);

            self.logger.trace({
              fileLocation
            }, 'local-storage: [search] search scoped file location: @{fileLocation}');

            _fs.default.readdir(fileLocation, function (err, files) {
              if (err) {
                return cb(err);
              }

              _async.default.eachSeries(files, (file2, cb) => {
                if (validateName(file2)) {
                  const packagePath = _path.default.resolve(base, storage, file, file2);

                  _fs.default.stat(packagePath, (err, stats) => {
                    if (_lodash.default.isNil(err) === false) {
                      return cb(err);
                    }

                    const item = {
                      name: `${file}/${file2}`,
                      path: packagePath,
                      time: stats.mtime.getTime()
                    };
                    onPackage(item, cb);
                  });
                } else {
                  cb();
                }
              }, cb);
            });
          } else if (validateName(file)) {
            const base2 = _path.default.join(position !== 0 ? storageKeys[0] : '');

            const packagePath = _path.default.resolve(base, base2, storage, file);

            self.logger.trace({
              packagePath
            }, 'local-storage: [search] search file location: @{packagePath}');

            _fs.default.stat(packagePath, (err, stats) => {
              if (_lodash.default.isNil(err) === false) {
                return cb(err);
              }

              onPackage({
                name: file,
                path: packagePath,
                time: self._getTime(stats.mtime.getTime(), stats.mtime)
              }, cb);
            });
          } else {
            cb();
          }
        }, cb);
      });
    }, onEnd);
  }
  /**
   * Remove an element from the database.
   * @param {*} name
   * @return {Error|*}
   */


  remove(name, cb) {
    this.get((err, data) => {
      if (err) {
        cb((0, _lib.getInternalError)('error remove private package'));
        this.logger.error({
          err
        }, '[local-storage/remove]: remove the private package has failed @{err}');
      }

      const pkgName = data.indexOf(name);

      if (pkgName !== -1) {
        this.data.list.splice(pkgName, 1);
        this.logger.trace({
          name
        }, 'local-storage: [remove] package @{name} has been removed');
      }

      cb(this._sync());
    });
  }
  /**
   * Return all database elements.
   * @return {Array}
   */


  get(cb) {
    const list = this.data.list;
    const totalItems = this.data.list.length;
    cb(null, list);
    this.logger.trace({
      totalItems
    }, 'local-storage: [get] full list of packages (@{totalItems}) has been fetched');
  }

  getPackageStorage(packageName) {
    const packageAccess = this.config.getMatchedPackagesSpec(packageName);

    const packagePath = this._getLocalStoragePath(packageAccess ? packageAccess.storage : undefined);

    this.logger.trace({
      packagePath
    }, '[local-storage/getPackageStorage]: storage selected: @{packagePath}');

    if (_lodash.default.isString(packagePath) === false) {
      this.logger.debug({
        name: packageName
      }, 'this package has no storage defined: @{name}');
      return;
    }

    const packageStoragePath = _path.default.join(_path.default.resolve(_path.default.dirname(this.config.self_path || ''), packagePath), packageName);

    this.logger.trace({
      packageStoragePath
    }, '[local-storage/getPackageStorage]: storage path: @{packageStoragePath}');
    return new _localFs.default(packageStoragePath, this.logger);
  }

  clean() {
    this._sync();
  }

  saveToken(token) {
    const key = this._getTokenKey(token);

    const db = this.getTokenDb();
    return new Promise((resolve, reject) => {
      db.put(key, token, err => {
        if (err) {
          reject(err);
          return;
        }

        resolve();
      });
    });
  }

  deleteToken(user, tokenKey) {
    const key = this._compoundTokenKey(user, tokenKey);

    const db = this.getTokenDb();
    return new Promise((resolve, reject) => {
      db.del(key, err => {
        if (err) {
          reject(err);
          return;
        }

        resolve();
      });
    });
  }

  readTokens(filter) {
    return new Promise((resolve, reject) => {
      const tokens = [];
      const key = filter.user + ':';
      const db = this.getTokenDb();
      const stream = db.createReadStream({
        gte: key,
        lte: String.fromCharCode(key.charCodeAt(0) + 1)
      });
      stream.on('data', data => {
        tokens.push(data.value);
      });
      stream.once('end', () => resolve(tokens));
      stream.once('error', err => reject(err));
    });
  }

  _getTime(time, mtime) {
    return time ? time : mtime;
  }

  _getCustomPackageLocalStorages() {
    const storages = {}; // add custom storage if exist

    if (this.config.storage) {
      storages[this.config.storage] = true;
    }

    const {
      packages
    } = this.config;

    if (packages) {
      const listPackagesConf = Object.keys(packages || {});
      listPackagesConf.map(pkg => {
        const storage = packages[pkg].storage;

        if (storage) {
          storages[storage] = false;
        }
      });
    }

    return storages;
  }
  /**
   * Syncronize {create} database whether does not exist.
   * @return {Error|*}
   */


  _sync() {
    this.logger.debug('[local-storage/_sync]: init sync database');

    if (this.locked) {
      this.logger.error('Database is locked, please check error message printed during startup to prevent data loss.');
      return new Error('Verdaccio database is locked, please contact your administrator to checkout logs during verdaccio startup.');
    } // Uses sync to prevent ugly race condition


    try {
      // https://www.npmjs.com/package/mkdirp#mkdirpsyncdir-opts
      const folderName = _path.default.dirname(this.path);

      _mkdirp.default.sync(folderName);

      this.logger.debug({
        folderName
      }, '[local-storage/_sync]: folder @{folderName} created succeed');
    } catch (err) {
      // perhaps a logger instance?
      this.logger.debug({
        err
      }, '[local-storage/_sync/mkdirp.sync]: sync failed @{err}');
      return null;
    }

    try {
      _fs.default.writeFileSync(this.path, JSON.stringify(this.data));

      this.logger.debug('[local-storage/_sync/writeFileSync]: sync write succeed');
      return null;
    } catch (err) {
      this.logger.debug({
        err
      }, '[local-storage/_sync/writeFileSync]: sync failed @{err}');
      return err;
    }
  }
  /**
   * Verify the right local storage location.
   * @param {String} path
   * @return {String}
   * @private
   */


  _getLocalStoragePath(storage) {
    const globalConfigStorage = this.config ? this.config.storage : undefined;

    if (_lodash.default.isNil(globalConfigStorage)) {
      throw new Error('global storage is required for this plugin');
    } else {
      if (_lodash.default.isNil(storage) === false && _lodash.default.isString(storage)) {
        return _path.default.join(globalConfigStorage, storage);
      }

      return globalConfigStorage;
    }
  }
  /**
   * Build the local database path.
   * @param {Object} config
   * @return {string|String|*}
   * @private
   */


  _buildStoragePath(config) {
    const sinopiadbPath = this._dbGenPath(DEPRECATED_DB_NAME, config);

    try {
      _fs.default.accessSync(sinopiadbPath, _fs.default.constants.F_OK);

      return sinopiadbPath;
    } catch (err) {
      if (err.code === _localFs.noSuchFile) {
        return this._dbGenPath(DB_NAME, config);
      }

      throw err;
    }
  }

  _dbGenPath(dbName, config) {
    return _path.default.join(_path.default.resolve(_path.default.dirname(config.self_path || ''), config.storage, dbName));
  }
  /**
   * Fetch local packages.
   * @private
   * @return {Object}
   */


  _fetchLocalPackages() {
    const list = [];
    const emptyDatabase = {
      list,
      secret: ''
    };

    try {
      const db = (0, _pkgUtils.loadPrivatePackages)(this.path, this.logger);
      return db;
    } catch (err) {
      // readFileSync is platform specific, macOS, Linux and Windows thrown an error
      // Only recreate if file not found to prevent data loss
      if (err.code !== _localFs.noSuchFile) {
        this.locked = true;
        this.logger.error('Failed to read package database file, please check the error printed below:\n', `File Path: ${this.path}\n\n ${err.message}`);
      }

      return emptyDatabase;
    }
  }

  getTokenDb() {
    if (!this.tokenDb) {
      this.tokenDb = (0, _level.default)(this._dbGenPath(TOKEN_DB_NAME, this.config), {
        valueEncoding: 'json'
      });
    }

    return this.tokenDb;
  }

  _getTokenKey(token) {
    const {
      user,
      key
    } = token;
    return this._compoundTokenKey(user, key);
  }

  _compoundTokenKey(user, key) {
    return `${user}:${key}`;
  }

}

var _default = LocalDatabase;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9sb2NhbC1kYXRhYmFzZS50cyJdLCJuYW1lcyI6WyJERVBSRUNBVEVEX0RCX05BTUUiLCJEQl9OQU1FIiwiVE9LRU5fREJfTkFNRSIsIkxvY2FsRGF0YWJhc2UiLCJjb25zdHJ1Y3RvciIsImNvbmZpZyIsImxvZ2dlciIsInBhdGgiLCJfYnVpbGRTdG9yYWdlUGF0aCIsImxvY2tlZCIsImRhdGEiLCJfZmV0Y2hMb2NhbFBhY2thZ2VzIiwidHJhY2UiLCJKU09OIiwic3RyaW5naWZ5IiwiX3N5bmMiLCJnZXRTZWNyZXQiLCJQcm9taXNlIiwicmVzb2x2ZSIsInNlY3JldCIsInNldFNlY3JldCIsImFkZCIsIm5hbWUiLCJjYiIsImxpc3QiLCJpbmRleE9mIiwicHVzaCIsImRlYnVnIiwic2VhcmNoIiwib25QYWNrYWdlIiwib25FbmQiLCJ2YWxpZGF0ZU5hbWUiLCJzdG9yYWdlcyIsIl9nZXRDdXN0b21QYWNrYWdlTG9jYWxTdG9yYWdlcyIsImJhc2UiLCJQYXRoIiwiZGlybmFtZSIsInNlbGZfcGF0aCIsInNlbGYiLCJzdG9yYWdlS2V5cyIsIk9iamVjdCIsImtleXMiLCJhc3luYyIsImVhY2hTZXJpZXMiLCJzdG9yYWdlIiwicG9zaXRpb24iLCJiYXNlMiIsImpvaW4iLCJzdG9yYWdlUGF0aCIsImZzIiwicmVhZGRpciIsImVyciIsImZpbGVzIiwiZmlsZSIsImluY2x1ZGVzIiwibWF0Y2giLCJmaWxlTG9jYXRpb24iLCJmaWxlMiIsInBhY2thZ2VQYXRoIiwic3RhdCIsInN0YXRzIiwiXyIsImlzTmlsIiwiaXRlbSIsInRpbWUiLCJtdGltZSIsImdldFRpbWUiLCJfZ2V0VGltZSIsInJlbW92ZSIsImdldCIsImVycm9yIiwicGtnTmFtZSIsInNwbGljZSIsInRvdGFsSXRlbXMiLCJsZW5ndGgiLCJnZXRQYWNrYWdlU3RvcmFnZSIsInBhY2thZ2VOYW1lIiwicGFja2FnZUFjY2VzcyIsImdldE1hdGNoZWRQYWNrYWdlc1NwZWMiLCJfZ2V0TG9jYWxTdG9yYWdlUGF0aCIsInVuZGVmaW5lZCIsImlzU3RyaW5nIiwicGFja2FnZVN0b3JhZ2VQYXRoIiwiTG9jYWxEcml2ZXIiLCJjbGVhbiIsInNhdmVUb2tlbiIsInRva2VuIiwia2V5IiwiX2dldFRva2VuS2V5IiwiZGIiLCJnZXRUb2tlbkRiIiwicmVqZWN0IiwicHV0IiwiZGVsZXRlVG9rZW4iLCJ1c2VyIiwidG9rZW5LZXkiLCJfY29tcG91bmRUb2tlbktleSIsImRlbCIsInJlYWRUb2tlbnMiLCJmaWx0ZXIiLCJ0b2tlbnMiLCJzdHJlYW0iLCJjcmVhdGVSZWFkU3RyZWFtIiwiZ3RlIiwibHRlIiwiU3RyaW5nIiwiZnJvbUNoYXJDb2RlIiwiY2hhckNvZGVBdCIsIm9uIiwidmFsdWUiLCJvbmNlIiwicGFja2FnZXMiLCJsaXN0UGFja2FnZXNDb25mIiwibWFwIiwicGtnIiwiRXJyb3IiLCJmb2xkZXJOYW1lIiwibWtkaXJwIiwic3luYyIsIndyaXRlRmlsZVN5bmMiLCJnbG9iYWxDb25maWdTdG9yYWdlIiwic2lub3BpYWRiUGF0aCIsIl9kYkdlblBhdGgiLCJhY2Nlc3NTeW5jIiwiY29uc3RhbnRzIiwiRl9PSyIsImNvZGUiLCJub1N1Y2hGaWxlIiwiZGJOYW1lIiwiZW1wdHlEYXRhYmFzZSIsIm1lc3NhZ2UiLCJ0b2tlbkRiIiwidmFsdWVFbmNvZGluZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUdBOztBQUNBOztBQUNBOztBQVlBOztBQUNBOztBQUVBOztBQUNBOzs7Ozs7Ozs7O0FBRUEsTUFBTUEsa0JBQWtCLEdBQUcsa0JBQTNCO0FBQ0EsTUFBTUMsT0FBTyxHQUFHLG9CQUFoQjtBQUNBLE1BQU1DLGFBQWEsR0FBRyxXQUF0Qjs7QUFZQTs7O0FBR0EsTUFBTUMsYUFBTixDQUFrRDtBQVFoRDs7OztBQUlPQyxFQUFBQSxXQUFQLENBQW1CQyxNQUFuQixFQUFtQ0MsTUFBbkMsRUFBbUQ7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFDakQsU0FB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LEtBQUt5QyxPQUFWLEVBQW1CO0FBQ2pCLFdBQUtBLE9BQUwsR0FBZSxvQkFBTSxLQUFLVCxVQUFMLENBQWdCeEgsYUFBaEIsRUFBK0IsS0FBS0csTUFBcEMsQ0FBTixFQUFtRDtBQUNoRStILFFBQUFBLGFBQWEsRUFBRTtBQURpRCxPQUFuRCxDQUFmO0FBR0Q7O0FBRUQsV0FBTyxLQUFLRCxPQUFaO0FBQ0Q7O0FBRU8zQyxFQUFBQSxZQUFSLENBQXFCRixLQUFyQixFQUEyQztBQUN6QyxVQUFNO0FBQUVRLE1BQUFBLElBQUY7QUFBUVAsTUFBQUE7QUFBUixRQUFnQkQsS0FBdEI7QUFDQSxXQUFPLEtBQUtVLGlCQUFMLENBQXVCRixJQUF2QixFQUE2QlAsR0FBN0IsQ0FBUDtBQUNEOztBQUVPUyxFQUFBQSxpQkFBUixDQUEwQkYsSUFBMUIsRUFBd0NQLEdBQXhDLEVBQTZEO0FBQzNELFdBQVEsR0FBRU8sSUFBSyxJQUFHUCxHQUFJLEVBQXRCO0FBQ0Q7O0FBelorQzs7ZUE0Wm5DcEYsYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgUGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBzdHJlYW0gZnJvbSAnc3RyZWFtJztcblxuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBhc3luYyBmcm9tICdhc3luYyc7XG5pbXBvcnQgbWtkaXJwIGZyb20gJ21rZGlycCc7XG5pbXBvcnQge1xuICBDYWxsYmFjayxcbiAgQ29uZmlnLFxuICBJUGFja2FnZVN0b3JhZ2UsXG4gIElQbHVnaW5TdG9yYWdlLFxuICBMb2NhbFN0b3JhZ2UsXG4gIExvZ2dlcixcbiAgU3RvcmFnZUxpc3QsXG4gIFRva2VuLFxuICBUb2tlbkZpbHRlcixcbn0gZnJvbSAnQHZlcmRhY2Npby90eXBlcyc7XG5pbXBvcnQgbGV2ZWwgZnJvbSAnbGV2ZWwnO1xuaW1wb3J0IHsgZ2V0SW50ZXJuYWxFcnJvciB9IGZyb20gJ0B2ZXJkYWNjaW8vY29tbW9ucy1hcGkvbGliJztcblxuaW1wb3J0IExvY2FsRHJpdmVyLCB7IG5vU3VjaEZpbGUgfSBmcm9tICcuL2xvY2FsLWZzJztcbmltcG9ydCB7IGxvYWRQcml2YXRlUGFja2FnZXMgfSBmcm9tICcuL3BrZy11dGlscyc7XG5cbmNvbnN0IERFUFJFQ0FURURfREJfTkFNRSA9ICcuc2lub3BpYS1kYi5qc29uJztcbmNvbnN0IERCX05BTUUgPSAnLnZlcmRhY2Npby1kYi5qc29uJztcbmNvbnN0IFRPS0VOX0RCX05BTUUgPSAnLnRva2VuLWRiJztcblxuaW50ZXJmYWNlIExldmVsIHtcbiAgcHV0KGtleTogc3RyaW5nLCB0b2tlbiwgZm4/OiBGdW5jdGlvbik6IHZvaWQ7XG5cbiAgZ2V0KGtleTogc3RyaW5nLCBmbj86IEZ1bmN0aW9uKTogdm9pZDtcblxuICBkZWwoa2V5OiBzdHJpbmcsIGZuPzogRnVuY3Rpb24pOiB2b2lkO1xuXG4gIGNyZWF0ZVJlYWRTdHJlYW0ob3B0aW9ucz86IG9iamVjdCk6IHN0cmVhbS5SZWFkYWJsZTtcbn1cblxuLyoqXG4gKiBIYW5kbGUgbG9jYWwgZGF0YWJhc2UuXG4gKi9cbmNsYXNzIExvY2FsRGF0YWJhc2UgaW1wbGVtZW50cyBJUGx1Z2luU3RvcmFnZTx7fT4ge1xuICBwdWJsaWMgcGF0aDogc3RyaW5nO1xuICBwdWJsaWMgbG9nZ2VyOiBMb2dnZXI7XG4gIHB1YmxpYyBkYXRhOiBMb2NhbFN0b3JhZ2U7XG4gIHB1YmxpYyBjb25maWc6IENvbmZpZztcbiAgcHVibGljIGxvY2tlZDogYm9vbGVhbjtcbiAgcHVibGljIHRva2VuRGI7XG5cbiAgLyoqXG4gICAqIExvYWQgYW4gcGFyc2UgdGhlIGxvY2FsIGpzb24gZGF0YWJhc2UuXG4gICAqIEBwYXJhbSB7Kn0gcGF0aCB0aGUgZGF0YWJhc2UgcGF0aFxuICAgKi9cbiAgcHVibGljIGNvbnN0cnVjdG9yKGNvbmZpZzogQ29uZmlnLCBsb2dnZXI6IExvZ2dlcikge1xuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgIHRoaXMucGF0aCA9IHRoaXMuX2J1aWxkU3RvcmFnZVBhdGgoY29uZmlnKTtcbiAgICB0aGlzLmxvZ2dlciA9IGxvZ2dlcjtcbiAgICB0aGlzLmxvY2tlZCA9IGZhbHNlO1xuICAgIHRoaXMuZGF0YSA9IHRoaXMuX2ZldGNoTG9jYWxQYWNrYWdlcygpO1xuXG4gICAgdGhpcy5sb2dnZXIudHJhY2UoeyBjb25maWc6IEpTT04uc3RyaW5naWZ5KHRoaXMuY29uZmlnLCBudWxsLCA0KSB9LCAnW2xvY2FsLXN0b3JhZ2VdOiBjb25maWd1cmF0aW9uOiBAe2NvbmZpZ30nKTtcblxuICAgIHRoaXMuX3N5bmMoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRTZWNyZXQoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMuZGF0YS5zZWNyZXQpO1xuICB9XG5cbiAgcHVibGljIHNldFNlY3JldChzZWNyZXQ6IHN0cmluZyk6IFByb21pc2U8RXJyb3IgfCBudWxsPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKTogdm9pZCA9PiB7XG4gICAgICB0aGlzLmRhdGEuc2VjcmV0ID0gc2VjcmV0O1xuXG4gICAgICByZXNvbHZlKHRoaXMuX3N5bmMoKSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGEgbmV3IGVsZW1lbnQuXG4gICAqIEBwYXJhbSB7Kn0gbmFtZVxuICAgKiBAcmV0dXJuIHtFcnJvcnwqfVxuICAgKi9cbiAgcHVibGljIGFkZChuYW1lOiBzdHJpbmcsIGNiOiBDYWxsYmFjayk6IHZvaWQge1xuICAgIGlmICh0aGlzLmRhdGEubGlzdC5pbmRleE9mKG5hbWUpID09PSAtMSkge1xuICAgICAgdGhpcy5kYXRhLmxpc3QucHVzaChuYW1lKTtcblxuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoeyBuYW1lIH0sICdbbG9jYWwtc3RvcmFnZV06IHRoZSBwcml2YXRlIHBhY2thZ2UgQHtuYW1lfSBoYXMgYmVlbiBhZGRlZCcpO1xuICAgICAgY2IodGhpcy5fc3luYygpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY2IobnVsbCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNlYXJjaChvblBhY2thZ2U6IENhbGxiYWNrLCBvbkVuZDogQ2FsbGJhY2ssIHZhbGlkYXRlTmFtZTogKG5hbWU6IHN0cmluZykgPT4gYm9vbGVhbik6IHZvaWQge1xuICAgIGNvbnN0IHN0b3JhZ2VzID0gdGhpcy5fZ2V0Q3VzdG9tUGFja2FnZUxvY2FsU3RvcmFnZXMoKTtcbiAgICB0aGlzLmxvZ2dlci50cmFjZShgbG9jYWwtc3RvcmFnZTogW3NlYXJjaF06ICR7SlNPTi5zdHJpbmdpZnkoc3RvcmFnZXMpfWApO1xuICAgIGNvbnN0IGJhc2UgPSBQYXRoLmRpcm5hbWUodGhpcy5jb25maWcuc2VsZl9wYXRoKTtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICBjb25zdCBzdG9yYWdlS2V5cyA9IE9iamVjdC5rZXlzKHN0b3JhZ2VzKTtcbiAgICB0aGlzLmxvZ2dlci50cmFjZShgbG9jYWwtc3RvcmFnZTogW3NlYXJjaF0gYmFzZTogJHtiYXNlfSBrZXlzICR7c3RvcmFnZUtleXN9YCk7XG5cbiAgICBhc3luYy5lYWNoU2VyaWVzKFxuICAgICAgc3RvcmFnZUtleXMsXG4gICAgICBmdW5jdGlvbihzdG9yYWdlLCBjYikge1xuICAgICAgICBjb25zdCBwb3NpdGlvbiA9IHN0b3JhZ2VLZXlzLmluZGV4T2Yoc3RvcmFnZSk7XG4gICAgICAgIGNvbnN0IGJhc2UyID0gUGF0aC5qb2luKHBvc2l0aW9uICE9PSAwID8gc3RvcmFnZUtleXNbMF0gOiAnJyk7XG4gICAgICAgIGNvbnN0IHN0b3JhZ2VQYXRoOiBzdHJpbmcgPSBQYXRoLnJlc29sdmUoYmFzZSwgYmFzZTIsIHN0b3JhZ2UpO1xuICAgICAgICBzZWxmLmxvZ2dlci50cmFjZSh7IHN0b3JhZ2VQYXRoLCBzdG9yYWdlIH0sICdsb2NhbC1zdG9yYWdlOiBbc2VhcmNoXSBzZWFyY2ggcGF0aDogQHtzdG9yYWdlUGF0aH0gOiBAe3N0b3JhZ2V9Jyk7XG4gICAgICAgIGZzLnJlYWRkaXIoc3RvcmFnZVBhdGgsIChlcnIsIGZpbGVzKSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgcmV0dXJuIGNiKGVycik7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgYXN5bmMuZWFjaFNlcmllcyhcbiAgICAgICAgICAgIGZpbGVzLFxuICAgICAgICAgICAgZnVuY3Rpb24oZmlsZSwgY2IpIHtcbiAgICAgICAgICAgICAgc2VsZi5sb2dnZXIudHJhY2UoeyBmaWxlIH0sICdsb2NhbC1zdG9yYWdlOiBbc2VhcmNoXSBzZWFyY2ggZmlsZSBwYXRoOiBAe2ZpbGV9Jyk7XG4gICAgICAgICAgICAgIGlmIChzdG9yYWdlS2V5cy5pbmNsdWRlcyhmaWxlKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBjYigpO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgaWYgKGZpbGUubWF0Y2goL15ALykpIHtcbiAgICAgICAgICAgICAgICAvLyBzY29wZWRcbiAgICAgICAgICAgICAgICBjb25zdCBmaWxlTG9jYXRpb24gPSBQYXRoLnJlc29sdmUoYmFzZSwgc3RvcmFnZSwgZmlsZSk7XG4gICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIudHJhY2UoXG4gICAgICAgICAgICAgICAgICB7IGZpbGVMb2NhdGlvbiB9LFxuICAgICAgICAgICAgICAgICAgJ2xvY2FsLXN0b3JhZ2U6IFtzZWFyY2hdIHNlYXJjaCBzY29wZWQgZmlsZSBsb2NhdGlvbjogQHtmaWxlTG9jYXRpb259J1xuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgZnMucmVhZGRpcihmaWxlTG9jYXRpb24sIGZ1bmN0aW9uKGVyciwgZmlsZXMpIHtcbiAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNiKGVycik7XG4gICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgIGFzeW5jLmVhY2hTZXJpZXMoXG4gICAgICAgICAgICAgICAgICAgIGZpbGVzLFxuICAgICAgICAgICAgICAgICAgICAoZmlsZTIsIGNiKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbGlkYXRlTmFtZShmaWxlMikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhY2thZ2VQYXRoID0gUGF0aC5yZXNvbHZlKGJhc2UsIHN0b3JhZ2UsIGZpbGUsIGZpbGUyKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgZnMuc3RhdChwYWNrYWdlUGF0aCwgKGVyciwgc3RhdHMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF8uaXNOaWwoZXJyKSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2IoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpdGVtID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGAke2ZpbGV9LyR7ZmlsZTJ9YCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoOiBwYWNrYWdlUGF0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lOiBzdGF0cy5tdGltZS5nZXRUaW1lKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICAgIG9uUGFja2FnZShpdGVtLCBjYik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2IoKTtcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIGNiXG4gICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZhbGlkYXRlTmFtZShmaWxlKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGJhc2UyID0gUGF0aC5qb2luKHBvc2l0aW9uICE9PSAwID8gc3RvcmFnZUtleXNbMF0gOiAnJyk7XG4gICAgICAgICAgICAgICAgY29uc3QgcGFja2FnZVBhdGggPSBQYXRoLnJlc29sdmUoYmFzZSwgYmFzZTIsIHN0b3JhZ2UsIGZpbGUpO1xuICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLnRyYWNlKHsgcGFja2FnZVBhdGggfSwgJ2xvY2FsLXN0b3JhZ2U6IFtzZWFyY2hdIHNlYXJjaCBmaWxlIGxvY2F0aW9uOiBAe3BhY2thZ2VQYXRofScpO1xuICAgICAgICAgICAgICAgIGZzLnN0YXQocGFja2FnZVBhdGgsIChlcnIsIHN0YXRzKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAoXy5pc05pbChlcnIpID09PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2IoZXJyKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIG9uUGFja2FnZShcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGZpbGUsXG4gICAgICAgICAgICAgICAgICAgICAgcGF0aDogcGFja2FnZVBhdGgsXG4gICAgICAgICAgICAgICAgICAgICAgdGltZTogc2VsZi5fZ2V0VGltZShzdGF0cy5tdGltZS5nZXRUaW1lKCksIHN0YXRzLm10aW1lKSxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgY2JcbiAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY2IoKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGNiXG4gICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICAgb25FbmRcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSBhbiBlbGVtZW50IGZyb20gdGhlIGRhdGFiYXNlLlxuICAgKiBAcGFyYW0geyp9IG5hbWVcbiAgICogQHJldHVybiB7RXJyb3J8Kn1cbiAgICovXG4gIHB1YmxpYyByZW1vdmUobmFtZTogc3RyaW5nLCBjYjogQ2FsbGJhY2spOiB2b2lkIHtcbiAgICB0aGlzLmdldCgoZXJyLCBkYXRhKSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIGNiKGdldEludGVybmFsRXJyb3IoJ2Vycm9yIHJlbW92ZSBwcml2YXRlIHBhY2thZ2UnKSk7XG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKHsgZXJyIH0sICdbbG9jYWwtc3RvcmFnZS9yZW1vdmVdOiByZW1vdmUgdGhlIHByaXZhdGUgcGFja2FnZSBoYXMgZmFpbGVkIEB7ZXJyfScpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBwa2dOYW1lID0gZGF0YS5pbmRleE9mKG5hbWUpO1xuICAgICAgaWYgKHBrZ05hbWUgIT09IC0xKSB7XG4gICAgICAgIHRoaXMuZGF0YS5saXN0LnNwbGljZShwa2dOYW1lLCAxKTtcblxuICAgICAgICB0aGlzLmxvZ2dlci50cmFjZSh7IG5hbWUgfSwgJ2xvY2FsLXN0b3JhZ2U6IFtyZW1vdmVdIHBhY2thZ2UgQHtuYW1lfSBoYXMgYmVlbiByZW1vdmVkJyk7XG4gICAgICB9XG5cbiAgICAgIGNiKHRoaXMuX3N5bmMoKSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIGFsbCBkYXRhYmFzZSBlbGVtZW50cy5cbiAgICogQHJldHVybiB7QXJyYXl9XG4gICAqL1xuICBwdWJsaWMgZ2V0KGNiOiBDYWxsYmFjayk6IHZvaWQge1xuICAgIGNvbnN0IGxpc3QgPSB0aGlzLmRhdGEubGlzdDtcbiAgICBjb25zdCB0b3RhbEl0ZW1zID0gdGhpcy5kYXRhLmxpc3QubGVuZ3RoO1xuXG4gICAgY2IobnVsbCwgbGlzdCk7XG5cbiAgICB0aGlzLmxvZ2dlci50cmFjZSh7IHRvdGFsSXRlbXMgfSwgJ2xvY2FsLXN0b3JhZ2U6IFtnZXRdIGZ1bGwgbGlzdCBvZiBwYWNrYWdlcyAoQHt0b3RhbEl0ZW1zfSkgaGFzIGJlZW4gZmV0Y2hlZCcpO1xuICB9XG5cbiAgcHVibGljIGdldFBhY2thZ2VTdG9yYWdlKHBhY2thZ2VOYW1lOiBzdHJpbmcpOiBJUGFja2FnZVN0b3JhZ2Uge1xuICAgIGNvbnN0IHBhY2thZ2VBY2Nlc3MgPSB0aGlzLmNvbmZpZy5nZXRNYXRjaGVkUGFja2FnZXNTcGVjKHBhY2thZ2VOYW1lKTtcblxuICAgIGNvbnN0IHBhY2thZ2VQYXRoOiBzdHJpbmcgPSB0aGlzLl9nZXRMb2NhbFN0b3JhZ2VQYXRoKHBhY2thZ2VBY2Nlc3MgPyBwYWNrYWdlQWNjZXNzLnN0b3JhZ2UgOiB1bmRlZmluZWQpO1xuICAgIHRoaXMubG9nZ2VyLnRyYWNlKHsgcGFja2FnZVBhdGggfSwgJ1tsb2NhbC1zdG9yYWdlL2dldFBhY2thZ2VTdG9yYWdlXTogc3RvcmFnZSBzZWxlY3RlZDogQHtwYWNrYWdlUGF0aH0nKTtcblxuICAgIGlmIChfLmlzU3RyaW5nKHBhY2thZ2VQYXRoKSA9PT0gZmFsc2UpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKHsgbmFtZTogcGFja2FnZU5hbWUgfSwgJ3RoaXMgcGFja2FnZSBoYXMgbm8gc3RvcmFnZSBkZWZpbmVkOiBAe25hbWV9Jyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgcGFja2FnZVN0b3JhZ2VQYXRoOiBzdHJpbmcgPSBQYXRoLmpvaW4oXG4gICAgICBQYXRoLnJlc29sdmUoUGF0aC5kaXJuYW1lKHRoaXMuY29uZmlnLnNlbGZfcGF0aCB8fCAnJyksIHBhY2thZ2VQYXRoKSxcbiAgICAgIHBhY2thZ2VOYW1lXG4gICAgKTtcblxuICAgIHRoaXMubG9nZ2VyLnRyYWNlKHsgcGFja2FnZVN0b3JhZ2VQYXRoIH0sICdbbG9jYWwtc3RvcmFnZS9nZXRQYWNrYWdlU3RvcmFnZV06IHN0b3JhZ2UgcGF0aDogQHtwYWNrYWdlU3RvcmFnZVBhdGh9Jyk7XG5cbiAgICByZXR1cm4gbmV3IExvY2FsRHJpdmVyKHBhY2thZ2VTdG9yYWdlUGF0aCwgdGhpcy5sb2dnZXIpO1xuICB9XG5cbiAgcHVibGljIGNsZWFuKCk6IHZvaWQge1xuICAgIHRoaXMuX3N5bmMoKTtcbiAgfVxuXG4gIHB1YmxpYyBzYXZlVG9rZW4odG9rZW46IFRva2VuKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3Qga2V5ID0gdGhpcy5fZ2V0VG9rZW5LZXkodG9rZW4pO1xuICAgIGNvbnN0IGRiID0gdGhpcy5nZXRUb2tlbkRiKCk7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCk6IHZvaWQgPT4ge1xuICAgICAgZGIucHV0KGtleSwgdG9rZW4sIGVyciA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZGVsZXRlVG9rZW4odXNlcjogc3RyaW5nLCB0b2tlbktleTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3Qga2V5ID0gdGhpcy5fY29tcG91bmRUb2tlbktleSh1c2VyLCB0b2tlbktleSk7XG4gICAgY29uc3QgZGIgPSB0aGlzLmdldFRva2VuRGIoKTtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCk6IHZvaWQgPT4ge1xuICAgICAgZGIuZGVsKGtleSwgZXJyID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyByZWFkVG9rZW5zKGZpbHRlcjogVG9rZW5GaWx0ZXIpOiBQcm9taXNlPFRva2VuW10+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCk6IHZvaWQgPT4ge1xuICAgICAgY29uc3QgdG9rZW5zOiBUb2tlbltdID0gW107XG4gICAgICBjb25zdCBrZXkgPSBmaWx0ZXIudXNlciArICc6JztcbiAgICAgIGNvbnN0IGRiID0gdGhpcy5nZXRUb2tlbkRiKCk7XG4gICAgICBjb25zdCBzdHJlYW0gPSBkYi5jcmVhdGVSZWFkU3RyZWFtKHtcbiAgICAgICAgZ3RlOiBrZXksXG4gICAgICAgIGx0ZTogU3RyaW5nLmZyb21DaGFyQ29kZShrZXkuY2hhckNvZGVBdCgwKSArIDEpLFxuICAgICAgfSk7XG5cbiAgICAgIHN0cmVhbS5vbignZGF0YScsIGRhdGEgPT4ge1xuICAgICAgICB0b2tlbnMucHVzaChkYXRhLnZhbHVlKTtcbiAgICAgIH0pO1xuXG4gICAgICBzdHJlYW0ub25jZSgnZW5kJywgKCkgPT4gcmVzb2x2ZSh0b2tlbnMpKTtcblxuICAgICAgc3RyZWFtLm9uY2UoJ2Vycm9yJywgZXJyID0+IHJlamVjdChlcnIpKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldFRpbWUodGltZTogbnVtYmVyLCBtdGltZTogRGF0ZSk6IG51bWJlciB8IERhdGUge1xuICAgIHJldHVybiB0aW1lID8gdGltZSA6IG10aW1lO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0Q3VzdG9tUGFja2FnZUxvY2FsU3RvcmFnZXMoKTogb2JqZWN0IHtcbiAgICBjb25zdCBzdG9yYWdlcyA9IHt9O1xuXG4gICAgLy8gYWRkIGN1c3RvbSBzdG9yYWdlIGlmIGV4aXN0XG4gICAgaWYgKHRoaXMuY29uZmlnLnN0b3JhZ2UpIHtcbiAgICAgIHN0b3JhZ2VzW3RoaXMuY29uZmlnLnN0b3JhZ2VdID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBjb25zdCB7IHBhY2thZ2VzIH0gPSB0aGlzLmNvbmZpZztcblxuICAgIGlmIChwYWNrYWdlcykge1xuICAgICAgY29uc3QgbGlzdFBhY2thZ2VzQ29uZiA9IE9iamVjdC5rZXlzKHBhY2thZ2VzIHx8IHt9KTtcblxuICAgICAgbGlzdFBhY2thZ2VzQ29uZi5tYXAocGtnID0+IHtcbiAgICAgICAgY29uc3Qgc3RvcmFnZSA9IHBhY2thZ2VzW3BrZ10uc3RvcmFnZTtcbiAgICAgICAgaWYgKHN0b3JhZ2UpIHtcbiAgICAgICAgICBzdG9yYWdlc1tzdG9yYWdlXSA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3RvcmFnZXM7XG4gIH1cblxuICAvKipcbiAgICogU3luY3Jvbml6ZSB7Y3JlYXRlfSBkYXRhYmFzZSB3aGV0aGVyIGRvZXMgbm90IGV4aXN0LlxuICAgKiBAcmV0dXJuIHtFcnJvcnwqfVxuICAgKi9cbiAgcHJpdmF0ZSBfc3luYygpOiBFcnJvciB8IG51bGwge1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKCdbbG9jYWwtc3RvcmFnZS9fc3luY106IGluaXQgc3luYyBkYXRhYmFzZScpO1xuXG4gICAgaWYgKHRoaXMubG9ja2VkKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignRGF0YWJhc2UgaXMgbG9ja2VkLCBwbGVhc2UgY2hlY2sgZXJyb3IgbWVzc2FnZSBwcmludGVkIGR1cmluZyBzdGFydHVwIHRvIHByZXZlbnQgZGF0YSBsb3NzLicpO1xuICAgICAgcmV0dXJuIG5ldyBFcnJvcihcbiAgICAgICAgJ1ZlcmRhY2NpbyBkYXRhYmFzZSBpcyBsb2NrZWQsIHBsZWFzZSBjb250YWN0IHlvdXIgYWRtaW5pc3RyYXRvciB0byBjaGVja291dCBsb2dzIGR1cmluZyB2ZXJkYWNjaW8gc3RhcnR1cC4nXG4gICAgICApO1xuICAgIH1cbiAgICAvLyBVc2VzIHN5bmMgdG8gcHJldmVudCB1Z2x5IHJhY2UgY29uZGl0aW9uXG4gICAgdHJ5IHtcbiAgICAgIC8vIGh0dHBzOi8vd3d3Lm5wbWpzLmNvbS9wYWNrYWdlL21rZGlycCNta2RpcnBzeW5jZGlyLW9wdHNcbiAgICAgIGNvbnN0IGZvbGRlck5hbWUgPSBQYXRoLmRpcm5hbWUodGhpcy5wYXRoKTtcbiAgICAgIG1rZGlycC5zeW5jKGZvbGRlck5hbWUpO1xuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoeyBmb2xkZXJOYW1lIH0sICdbbG9jYWwtc3RvcmFnZS9fc3luY106IGZvbGRlciBAe2ZvbGRlck5hbWV9IGNyZWF0ZWQgc3VjY2VlZCcpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gcGVyaGFwcyBhIGxvZ2dlciBpbnN0YW5jZT9cbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKHsgZXJyIH0sICdbbG9jYWwtc3RvcmFnZS9fc3luYy9ta2RpcnAuc3luY106IHN5bmMgZmFpbGVkIEB7ZXJyfScpO1xuXG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgZnMud3JpdGVGaWxlU3luYyh0aGlzLnBhdGgsIEpTT04uc3RyaW5naWZ5KHRoaXMuZGF0YSkpO1xuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoJ1tsb2NhbC1zdG9yYWdlL19zeW5jL3dyaXRlRmlsZVN5bmNdOiBzeW5jIHdyaXRlIHN1Y2NlZWQnKTtcblxuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1Zyh7IGVyciB9LCAnW2xvY2FsLXN0b3JhZ2UvX3N5bmMvd3JpdGVGaWxlU3luY106IHN5bmMgZmFpbGVkIEB7ZXJyfScpO1xuXG4gICAgICByZXR1cm4gZXJyO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZnkgdGhlIHJpZ2h0IGxvY2FsIHN0b3JhZ2UgbG9jYXRpb24uXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoXG4gICAqIEByZXR1cm4ge1N0cmluZ31cbiAgICogQHByaXZhdGVcbiAgICovXG4gIHByaXZhdGUgX2dldExvY2FsU3RvcmFnZVBhdGgoc3RvcmFnZTogc3RyaW5nIHwgdm9pZCk6IHN0cmluZyB7XG4gICAgY29uc3QgZ2xvYmFsQ29uZmlnU3RvcmFnZSA9IHRoaXMuY29uZmlnID8gdGhpcy5jb25maWcuc3RvcmFnZSA6IHVuZGVmaW5lZDtcbiAgICBpZiAoXy5pc05pbChnbG9iYWxDb25maWdTdG9yYWdlKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdnbG9iYWwgc3RvcmFnZSBpcyByZXF1aXJlZCBmb3IgdGhpcyBwbHVnaW4nKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKF8uaXNOaWwoc3RvcmFnZSkgPT09IGZhbHNlICYmIF8uaXNTdHJpbmcoc3RvcmFnZSkpIHtcbiAgICAgICAgcmV0dXJuIFBhdGguam9pbihnbG9iYWxDb25maWdTdG9yYWdlIGFzIHN0cmluZywgc3RvcmFnZSBhcyBzdHJpbmcpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZ2xvYmFsQ29uZmlnU3RvcmFnZSBhcyBzdHJpbmc7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEJ1aWxkIHRoZSBsb2NhbCBkYXRhYmFzZSBwYXRoLlxuICAgKiBAcGFyYW0ge09iamVjdH0gY29uZmlnXG4gICAqIEByZXR1cm4ge3N0cmluZ3xTdHJpbmd8Kn1cbiAgICogQHByaXZhdGVcbiAgICovXG4gIHByaXZhdGUgX2J1aWxkU3RvcmFnZVBhdGgoY29uZmlnOiBDb25maWcpOiBzdHJpbmcge1xuICAgIGNvbnN0IHNpbm9waWFkYlBhdGg6IHN0cmluZyA9IHRoaXMuX2RiR2VuUGF0aChERVBSRUNBVEVEX0RCX05BTUUsIGNvbmZpZyk7XG4gICAgdHJ5IHtcbiAgICAgIGZzLmFjY2Vzc1N5bmMoc2lub3BpYWRiUGF0aCwgZnMuY29uc3RhbnRzLkZfT0spO1xuICAgICAgcmV0dXJuIHNpbm9waWFkYlBhdGg7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyLmNvZGUgPT09IG5vU3VjaEZpbGUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RiR2VuUGF0aChEQl9OQU1FLCBjb25maWcpO1xuICAgICAgfVxuXG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfZGJHZW5QYXRoKGRiTmFtZTogc3RyaW5nLCBjb25maWc6IENvbmZpZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIFBhdGguam9pbihQYXRoLnJlc29sdmUoUGF0aC5kaXJuYW1lKGNvbmZpZy5zZWxmX3BhdGggfHwgJycpLCBjb25maWcuc3RvcmFnZSBhcyBzdHJpbmcsIGRiTmFtZSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEZldGNoIGxvY2FsIHBhY2thZ2VzLlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcmV0dXJuIHtPYmplY3R9XG4gICAqL1xuICBwcml2YXRlIF9mZXRjaExvY2FsUGFja2FnZXMoKTogTG9jYWxTdG9yYWdlIHtcbiAgICBjb25zdCBsaXN0OiBTdG9yYWdlTGlzdCA9IFtdO1xuICAgIGNvbnN0IGVtcHR5RGF0YWJhc2UgPSB7IGxpc3QsIHNlY3JldDogJycgfTtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBkYiA9IGxvYWRQcml2YXRlUGFja2FnZXModGhpcy5wYXRoLCB0aGlzLmxvZ2dlcik7XG5cbiAgICAgIHJldHVybiBkYjtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIHJlYWRGaWxlU3luYyBpcyBwbGF0Zm9ybSBzcGVjaWZpYywgbWFjT1MsIExpbnV4IGFuZCBXaW5kb3dzIHRocm93biBhbiBlcnJvclxuICAgICAgLy8gT25seSByZWNyZWF0ZSBpZiBmaWxlIG5vdCBmb3VuZCB0byBwcmV2ZW50IGRhdGEgbG9zc1xuICAgICAgaWYgKGVyci5jb2RlICE9PSBub1N1Y2hGaWxlKSB7XG4gICAgICAgIHRoaXMubG9ja2VkID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICAgJ0ZhaWxlZCB0byByZWFkIHBhY2thZ2UgZGF0YWJhc2UgZmlsZSwgcGxlYXNlIGNoZWNrIHRoZSBlcnJvciBwcmludGVkIGJlbG93OlxcbicsXG4gICAgICAgICAgYEZpbGUgUGF0aDogJHt0aGlzLnBhdGh9XFxuXFxuICR7ZXJyLm1lc3NhZ2V9YFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZW1wdHlEYXRhYmFzZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldFRva2VuRGIoKTogTGV2ZWwge1xuICAgIGlmICghdGhpcy50b2tlbkRiKSB7XG4gICAgICB0aGlzLnRva2VuRGIgPSBsZXZlbCh0aGlzLl9kYkdlblBhdGgoVE9LRU5fREJfTkFNRSwgdGhpcy5jb25maWcpLCB7XG4gICAgICAgIHZhbHVlRW5jb2Rpbmc6ICdqc29uJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnRva2VuRGI7XG4gIH1cblxuICBwcml2YXRlIF9nZXRUb2tlbktleSh0b2tlbjogVG9rZW4pOiBzdHJpbmcge1xuICAgIGNvbnN0IHsgdXNlciwga2V5IH0gPSB0b2tlbjtcbiAgICByZXR1cm4gdGhpcy5fY29tcG91bmRUb2tlbktleSh1c2VyLCBrZXkpO1xuICB9XG5cbiAgcHJpdmF0ZSBfY29tcG91bmRUb2tlbktleSh1c2VyOiBzdHJpbmcsIGtleTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYCR7dXNlcn06JHtrZXl9YDtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBMb2NhbERhdGFiYXNlO1xuIl19